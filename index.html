<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>דשבורד פעילות ותוכניות</title>

  <style>
    body {
      margin: 0;
      font-family: 'Assistant', sans-serif;
      background: #f0fdf4;
      color: #052e16;
      min-height: 100vh;
      text-align: center;
      padding-bottom: 60px;
    }
    h1 { color: #15803d; margin: 20px 0; }
    .controls { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
    select,button{ background:#fff; color:#052e16; border:1px solid #86efac; border-radius:6px; padding:8px 12px; cursor:pointer; }
    .active-view{ background:#16a34a!important; color:#fff!important; font-weight:bold; }
    .calendar-grid{ display:flex; justify-content:space-around; gap:8px; max-width:1200px; margin:auto; flex-wrap:wrap; }
    .day{ flex:1; background:#fff; border:1px solid #bbf7d0; border-radius:10px; padding:10px; min-width:180px; min-height:200px; box-sizing:border-box; display:flex; flex-direction:column; }
    .calendar-grid.week .day{ border-right:1px solid #bbf7d0; }
    .calendar-grid.week .day:last-child{ border-right:none; }
    .day-header{ position:sticky; top:0; background:#ecfdf5; padding:5px 0; }
    .month-day-num{ font-size:1.2em; }
    .day h3{ color:#16a34a; margin:0; }
    .day small{ display:block; color:#065f46; margin-bottom:8px; }
    .event{ background:#ecfdf5; border:1px solid #6ee7b7; border-radius:8px; padding:6px; margin:5px 0; text-align:right; }
    .missing{ background:#fee2e2!important; border-color:#ef4444!important; }
    #summaryRow{ margin-top:20px; font-weight:bold; color:#15803d; }
    .worker-card{ text-align:right; gap:6px; }
    .worker-card .meta{ color:#065f46; font-size:.95em; }
    .cell-message{ color:#b91c1c; font-weight:bold; padding:20px; text-align:center; }
  </style>
</head>
<body>
<h1>דשבורד פעילות ותוכניות</h1>

<div class="controls">
  <select id="managerFilter"><option value="">בחר מנהל</option></select>
  <select id="workerFilter"><option value="">בחר עובד</option></select>
  <select id="programFilter"><option value="">בחר תוכנית</option></select>
  <select id="cityFilter"><option value="">בחר רשות</option></select>
  <button id="clearFilters">נקה סינון</button>
</div>

<div style="margin-bottom:10px; display:flex; justify-content:center; gap:10px;">
  <button id="viewWeek" class="active-view">תצוגת שבוע</button>
  <button id="viewMonth">תצוגת חודש</button>
  <button id="viewWorker">פילוח לפי עובד</button>
</div>

<div style="margin-bottom:10px;">
  <button id="prevNav">קודם</button>
  <span id="navTitle" style="font-weight:bold; margin:0 10px;"></span>
  <button id="nextNav">הבא</button>
</div>

<div class="calendar-grid" id="calendarGrid"></div>
<div id="summaryRow"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const EXCEL_URL = 'DASHBOARD.xlsx';

let rawData=[]; let currentDate=new Date(); currentDate.setHours(0,0,0,0); let currentView='week';
const days=['ראשון','שני','שלישי','רביעי','חמישי','שישי'];
const monthNames=['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];

prevNav.onclick=()=>changeNav(-1); nextNav.onclick=()=>changeNav(1);
viewWeek.onclick=()=>setView('week'); viewMonth.onclick=()=>setView('month'); viewWorker.onclick=()=>setView('worker');
clearFilters.onclick=clearAllFilters;

function normalize(s){return s.toString().replace(/\s+/g,'').toLowerCase();}

async function loadExcelFromServer(){
  try{
    const res = await fetch(EXCEL_URL,{cache:'no-store'});
    if(!res.ok) throw new Error();
    const buffer = await res.arrayBuffer();
    const wb = XLSX.read(buffer,{type:'array'});
    let data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''});
    if(!data.length){ showCellMessage('קובץ הנתונים ריק'); return; }

    const map={ 'עובד':['עובד','שםעובד','מדריך','מרצה'], 'מנהל':['מנהל','שםמנהל'], 'תוכנית':['תוכנית','קורס'], 'רשות':['רשות','עיר'], 'שעת התחלה':['שעתהתחלה','שעה'] };
    rawData=data.map(row=>{ const n={}; for(const k in row){ const nk=normalize(k);
      let done=false; for(const t in map){ if(map[t].some(o=>normalize(o)===nk)){ n[t]=row[k]; done=true; break; }}
      if(!done && nk.startsWith('תאריך')) n[k]=row[k]; }
      return n; });

    if(!rawData.some(r=>r['עובד'])){ showCellMessage('לא נמצאה עמודת עובד בקובץ'); return; }
    initFilters(); renderCalendar();
  }catch(e){ showCellMessage('שגיאה בטעינת נתונים'); }
}

function showCellMessage(msg){ calendarGrid.innerHTML=`<div class="day cell-message">${msg}</div>`; summaryRow.textContent=''; }

function initFilters(){ const m={manager:'מנהל',worker:'עובד',program:'תוכנית',city:'רשות'};
  Object.keys(m).forEach(k=>{ const s=document.getElementById(k+'Filter');
    const v=[...new Set(rawData.map(r=>r[m[k]]).filter(Boolean))].sort();
    s.innerHTML=`<option value="">בחר ${m[k]}</option>`+v.map(x=>`<option>${x}</option>`).join(''); s.onchange=renderCalendar; }); }

function setView(v){ currentView=v; viewWeek.classList.toggle('active-view',v==='week'); viewMonth.classList.toggle('active-view',v==='month'); viewWorker.classList.toggle('active-view',v==='worker'); if(v==='week') currentDate.setDate(currentDate.getDate()-currentDate.getDay()); if(v==='month') currentDate.setDate(1); renderCalendar(); }
function changeNav(d){ if(currentView==='week') currentDate.setDate(currentDate.getDate()+d*7); else if(currentView==='month') currentDate.setMonth(currentDate.getMonth()+d); renderCalendar(); }
function formatDate(d){ return String(d.getDate()).padStart(2,'0')+'.'+String(d.getMonth()+1).padStart(2,'0')+(currentView==='month'?'.'+d.getFullYear():''); }
function excelTimeToHHMM(v){ if(typeof v==='number'){const t=Math.round(v*1440); return String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0');} return v||''; }
function parseDate(v){ if(typeof v==='number'){ const e=new Date(Date.UTC(1899,11,30)); const d=new Date(e.getTime()+v*86400000); d.setHours(0,0,0,0); return d;} if(typeof v==='string'&&v.includes('.')){ const [d,m,y]=v.split('.').map(Number); const r=new Date(y>100?y:2000+y,m-1,d); r.setHours(0,0,0,0); return r;} return null; }
function datesEqual(a,b){ return a&&b&&a.getTime()===b.getTime(); }
function getFilteredData(){ let d=[...rawData]; const m={managerFilter:'מנהל',workerFilter:'עובד',programFilter:'תוכנית',cityFilter:'רשות'}; for(const id in m){ const v=document.getElementById(id).value.trim(); if(v) d=d.filter(r=>(r[m[id]]||'')===v);} return d; }
function clearAllFilters(){ document.querySelectorAll('select').forEach(s=>s.value=''); renderCalendar(); }
function getWeekDates(){ return Array.from({length:6},(_,i)=>{ const d=new Date(currentDate); d.setDate(currentDate.getDate()+i); d.setHours(0,0,0,0); return d; }); }
function getMonthDates(){ const a=[]; const f=new Date(currentDate.getFullYear(),currentDate.getMonth(),1); const s=new Date(f); s.setDate(f.getDate()-f.getDay()); for(let i=0;i<42;i++){ const d=new Date(s); d.setDate(s.getDate()+i); d.setHours(0,0,0,0); if(d.getDay()!==6) a.push(d);} return a.slice(0,Math.ceil(a.length/6)*6); }
function updateNavTitle(){ navTitle.textContent = currentView==='week' ? formatDate(getWeekDates()[0])+' - '+formatDate(getWeekDates()[5]) : currentView==='month' ? monthNames[currentDate.getMonth()]+' '+currentDate.getFullYear() : 'פילוח לפי עובדים'; }
function renderDayEvents(data,date){ let h=''; data.forEach(r=>{ for(let i=1;i<=16;i++){ const d=parseDate(r['תאריך'+i]); if(d&&datesEqual(d,date)){ const c=r['עובד']&&r['שעת התחלה']?'event':'event missing'; h+=`<div class="${c}"><strong>${r['עובד']||'—'}</strong><small>${r['תוכנית']||''}</small><span>${r['רשות']||''} ${excelTimeToHHMM(r['שעת התחלה'])}</span></div>`; }}}); return h||'<p style="color:#64748b;">—</p>'; }
function renderWeekly(){ updateNavTitle(); const g=calendarGrid; const d=getFilteredData(); const w=getWeekDates(); g.classList.add('week'); g.innerHTML=days.map((x,i)=>`<div class="day"><h3>${x}</h3><small>${formatDate(w[i])}</small>${renderDayEvents(d,w[i])}</div>`).join(''); summaryRow.textContent=`סה"כ עובדים: ${new Set(d.map(r=>r['עובד']).filter(Boolean)).size} | סה"כ רשומות: ${d.length}`; }
function renderMonthly(){ updateNavTitle(); const g=calendarGrid; const d=getFilteredData(); const dates=getMonthDates(); g.classList.remove('week'); g.innerHTML=days.map(x=>`<div class="day day-header"><h3>${x}</h3></div>`).join('')+dates.map(dt=>`<div class="day"><small>${days[dt.getDay()]}</small><span class="month-day-num">${dt.getDate()}</span>${renderDayEvents(d,dt)}</div>`).join(''); summaryRow.textContent=`סה"כ עובדים: ${new Set(d.map(r=>r['עובד']).filter(Boolean)).size} | סה"כ רשומות: ${d.length}`; }
function renderWorkerView(){ updateNavTitle(); const g=calendarGrid; const d=getFilteredData(); const by={}; d.forEach(r=>{ if(!r['עובד']) return; (by[r['עובד']]??=[]).push(r); }); const ws=Object.keys(by).sort(); g.classList.remove('week'); g.innerHTML=ws.map(w=>{ const rows=by[w]; const p=new Set(rows.map(r=>r['תוכנית']).filter(Boolean)); const c=new Set(rows.map(r=>r['רשות']).filter(Boolean)); const m=rows.filter(r=>!r['שעת התחלה']).length; return `<div class="day worker-card"><h3>${w}</h3><div class="meta">מפגשים: <strong>${rows.length}</strong></div><div class="meta">תוכניות: <strong>${p.size}</strong> | רשויות: <strong>${c.size}</strong></div><div class="meta">חוסרים (שעת התחלה): <strong>${m}</strong></div></div>`; }).join('')||'<p style="color:#64748b;">אין נתונים להצגה</p>'; summaryRow.textContent=`סה"כ עובדים מוצגים: ${ws.length}`; }
function renderCalendar(){ if(!rawData.length){ showCellMessage('אין נתונים להצגה'); return;} if(currentView==='week') renderWeekly(); else if(currentView==='month') renderMonthly(); else renderWorkerView(); }

setView('week');
loadExcelFromServer();
</script>
</body>
</html>
