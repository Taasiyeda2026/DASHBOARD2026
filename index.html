<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>דשבורד פעילויות</title>
<link rel="icon" href="logo.png" type="image/png">
<style>
:root{--bg-main:#f8fafc;--bg-surface:#eef2f7;--card-bg:#ffffff;--accent:#2563eb;--text-main:#0f172a;--text-muted:#475569;--border:#e2e8f0;--danger:#dc2626;}
body{margin:0;font-family:system-ui;background:linear-gradient(180deg,var(--bg-main),var(--bg-surface));color:var(--text-main);} 
header{background:#fff;border-bottom:1px solid var(--border);} 
.header-inner{max-width:1200px;margin:auto;padding:14px;display:flex;gap:16px;align-items:center;} 
.app-logo{height:42px;} 
.controls,.nav-controls{display:flex;justify-content:center;gap:8px;margin:10px auto;flex-wrap:wrap;} 
select,button{height:32px;font-size:13px;padding:4px 10px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer;}
.nav-btn{width:32px;height:32px;border-radius:999px;background:#fef9c3;border-color:#fde047;font-weight:700;}
.nav-controls{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:6px 0;}
.calendar-grid{max-width:1200px;margin:auto;padding:10px;display:grid;gap:12px;}
.day{background:var(--card-bg);border-radius:14px;padding:10px;box-shadow:0 6px 16px rgba(0,0,0,.08);} 
.day-header{font-size:13px;font-weight:700;text-align:center;border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:8px;}
.event{border-radius:10px;padding:8px;margin-top:6px;font-size:13px;border-right:3px solid var(--accent);background:#fff;} 
.event.missing{border:2px solid var(--danger);} 
.week-title{font-weight:700;margin:8px 0;text-align:center;}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <img src="logo.png" class="app-logo" alt="לוגו">
    <div><strong>דשבורד פעילויות</strong></div>
  </div>
</header>
<div class="controls">
  <select id="monthFilter"><option value="">בחירת חודש</option></select>
  <select id="managerFilter"><option value="">כל המנהלים</option></select>
  <select id="employeeFilter"><option value="">כל העובדים</option></select>
</div>
<div class="nav-controls">
  <button id="viewMonthBtn">חודש</button>
  <button id="viewWeekBtn">שבוע</button>
  <button id="viewSummaryBtn">סיכום</button>
  <button id="prevNav" class="nav-btn">▶</button>
  <span id="navTitle" style="min-width:180px;text-align:center;font-weight:bold"></span>
  <button id="nextNav" class="nav-btn">◀</button>
</div>
<div id="calendarGrid" class="calendar-grid"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let rawData=[],mode='month',currentDate=new Date();
const monthFilter=document.getElementById('monthFilter');
const managerFilter=document.getElementById('managerFilter');
const employeeFilter=document.getElementById('employeeFilter');
const grid=document.getElementById('calendarGrid');
const navTitle=document.getElementById('navTitle');

function parseDate(v){if(!v)return null;if(typeof v==='number'){const d=XLSX.SSF.parse_date_code(v);return new Date(d.y,d.m-1,d.d);}const d=new Date(v);return isNaN(d)?null:d;}

async function load(){
  const res=await fetch('./DASHBOARD.xlsx',{cache:'no-store'});
  const wb=XLSX.read(await res.arrayBuffer(),{type:'array'});
  const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:''});
  const h=rows[0];
  rawData=rows.slice(1).map(r=>{
    const get=n=>r[h.findIndex(x=>String(x).toLowerCase()===n.toLowerCase())]||'';
    const dates=[...Array(16)].map((_,i)=>parseDate(get('date'+(i+1))));
    return{Program:get('Program'),Employee:get('Employee'),Manager:get('Manager'),School:get('School'),Dates:dates};
  }).filter(r=>r.Dates.some(d=>d));
  initMonths();
  initPeople();
  render();
}

function initMonths(){
  const months=[...new Set(rawData.flatMap(r=>r.Dates.filter(Boolean).map(d=>d.getFullYear()+'-'+(d.getMonth()+1))))].sort();
  monthFilter.innerHTML='<option value="">בחירת חודש</option>'+months.map(k=>{
    const[y,m]=k.split('-');return`<option value="${k}">${new Date(y,m-1).toLocaleString('he-IL',{month:'long',year:'numeric'})}</option>`}).join('');
}

function initPeople(){
  const managers=[...new Set(rawData.map(r=>r.Manager).filter(Boolean))].sort();
  managerFilter.innerHTML='<option value="">כל המנהלים</option>'+managers.map(m=>`<option>${m}</option>`).join('');
  const employees=[...new Set(rawData.map(r=>r.Employee).filter(Boolean))].sort();
  employeeFilter.innerHTML='<option value="">כל העובדים</option>'+employees.map(e=>`<option>${e}</option>`).join('');
}

function getMonthData(){
  const y=currentDate.getFullYear();
  const m=currentDate.getMonth();
  return rawData.filter(r=>{
    if(managerFilter.value && r.Manager!==managerFilter.value) return false;
    if(employeeFilter.value && r.Employee!==employeeFilter.value) return false;
    return r.Dates.some(d=>d&&d.getFullYear()===y&&d.getMonth()===m);
  });
}

function render(){
  grid.innerHTML='';

  // שליטה בתצוגת סינונים לפי מצב
  if(mode==='summary'){
    managerFilter.style.display='none';
    employeeFilter.style.display='none';
  } else {
    managerFilter.style.display='';
    employeeFilter.style.display='';
  }

  const data=getMonthData();
  navTitle.textContent=currentDate.toLocaleString('he-IL',{month:'long',year:'numeric'});
  if(mode==='summary')return renderSummary(getMonthData().map(r=>r));
  if(mode==='week')return renderWeek(data);
  renderMonth(data);
}

function renderMonth(data){
  grid.style.gridTemplateColumns='repeat(auto-fit,minmax(260px,1fr))';
  const days={};
  data.forEach(r=>r.Dates.forEach(d=>{
    if(d&&d.getMonth()===currentDate.getMonth()){
      const k=d.toDateString();
      (days[k]=days[k]||[]).push(r);
    }
  }));
  Object.keys(days).sort((a,b)=>new Date(a)-new Date(b)).forEach(k=>{
    const day=new Date(k);
    const card=document.createElement('div');
    card.className='day';
    card.innerHTML=`<div class="day-header">${day.toLocaleDateString('he-IL',{weekday:'long',day:'numeric'})}</div>`+
      days[k].map(r=>`<div class="event"><strong>${r.Program}</strong><br><small>${r.Employee||'—'} · ${r.School||''}</small></div>`).join('');
    grid.appendChild(card);
  });
}

function renderWeek(data){
  grid.style.gridTemplateColumns='1fr';
  const start=new Date(currentDate);start.setDate(start.getDate()-start.getDay());
  const end=new Date(start);end.setDate(start.getDate()+6);
  const card=document.createElement('div');
  card.className='day';
  card.innerHTML=`<div class="day-header">שבוע ${start.toLocaleDateString('he-IL')} – ${end.toLocaleDateString('he-IL')}</div>`;
  data.forEach(r=>r.Dates.forEach(d=>{
    if(d&&d>=start&&d<=end){
      card.innerHTML+=`<div class="event"><strong>${r.Program}</strong><br><small>${r.Employee||'—'} · ${r.School||''} · ${d.toLocaleDateString('he-IL')}</small></div>`;
    }
  }));
  grid.appendChild(card);
}

function renderSummary(data){
  grid.style.gridTemplateColumns='1fr 1fr';
  const byManager={};
  data.forEach(r=>(byManager[r.Manager||'ללא מנהל']=byManager[r.Manager||'ללא מנהל']||[]).push(r));
  Object.keys(byManager).forEach(m=>{
    const card=document.createElement('div');
    card.className='day';
    card.innerHTML=`<div class="day-header">${m}</div>`+
      `<div style="text-align:center;font-size:34px;font-weight:800">${byManager[m].length}</div>`+
      byManager[m].map(r=>`<div class="event ${!r.Employee?'missing':''}"><strong>${r.Program}</strong><br><small>${r.Employee||'חסר מדריך'} · ${r.School||''}</small></div>`).join('');
    grid.appendChild(card);
  });
}

monthFilter.onchange=()=>{
  if(!monthFilter.value)return;
  const[y,m]=monthFilter.value.split('-');
  currentDate=new Date(y,m-1,1);
  render();
};

document.getElementById('viewMonthBtn').onclick=()=>{mode='month';render();};
document.getElementById('viewWeekBtn').onclick=()=>{mode='week';render();};
document.getElementById('viewSummaryBtn').onclick=()=>{mode='summary';render();};
document.getElementById('prevNav').onclick=()=>{currentDate.setMonth(currentDate.getMonth()-1);render();};
document.getElementById('nextNav').onclick=()=>{currentDate.setMonth(currentDate.getMonth()+1);render();};

load();
</script>
</body>
</html>
