<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>דשבורד פעילות ותוכניות</title>

<style>
:root{
  --bg-main:#f8fafc;
  --bg-surface:#eef2f7;
  --card-bg:#ffffff;
  --accent:#2563eb;
  --accent-soft:#e0ecff;
  --text-main:#0f172a;
  --text-muted:#475569;
  --border:#e2e8f0;
}

body{margin:0;font-family:Assistant,system-ui,sans-serif;background:linear-gradient(180deg,var(--bg-main),var(--bg-surface));color:var(--text-main);} 
header{background:#fff;border-bottom:1px solid var(--border);} 
.header-inner{max-width:1200px;margin:auto;padding:14px;display:flex;gap:16px;align-items:center;} 
.app-logo{height:42px;} 

.controls,.nav-controls{display:flex;justify-content:center;gap:8px;margin:10px auto;flex-wrap:wrap;} 
select,button{height:32px;font-size:13px;padding:4px 10px;border-radius:8px;border:1px solid var(--border);background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.08);} 
.nav-btn{width:32px;height:32px;border-radius:999px;} 

.calendar-grid{max-width:1200px;margin:auto;padding:10px;display:grid;grid-template-columns:repeat(6,1fr);gap:12px;} 

.day{background:var(--card-bg);border-radius:14px;padding:10px;box-shadow:0 6px 16px rgba(0,0,0,.1);} 
.day-header{font-weight:700;margin-bottom:6px;cursor:pointer;} 
.event{background:linear-gradient(135deg,var(--accent-soft),#fff);border-radius:10px;padding:8px;margin-top:6px;font-size:13px;} 
.meta{font-size:12px;color:var(--text-muted);} 

@media(max-width:768px){.calendar-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <img src="logo.png" class="app-logo" alt="logo">
    <div>
      <strong>דשבורד פעילות ותוכניות</strong><br>
      <span class="meta">תצוגה חודשית / שבועית לפי תאריכים</span>
    </div>
  </div>
</header>

<div class="controls">
  <select id="managerFilter"><option value="">סינון לפי מנהל</option></select>
  <select id="programFilter"><option value="">סינון לפי תוכנית</option></select>
  <button id="clearFilters">נקה סינון</button>
</div>

<div class="nav-controls">
  <button id="viewMonthBtn" type="button">חודש</button>
  <button id="viewWeekBtn" type="button">שבוע</button>
  <button id="prevNav" class="nav-btn nav-prev" type="button">▶</button>
  <span id="navTitle"></span>
  <button id="nextNav" class="nav-btn nav-next" type="button">◀</button>
</div>

<div id="calendarGrid" class="calendar-grid"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ================= STATE =================
let activeWeeks = []; // weeks with activity
let activeWeekIndex = 0;
let rawData=[];
let currentDate=new Date(); currentDate.setHours(0,0,0,0);
let currentMode='month'; // 'month' | 'week'

const dayNames=['א','ב','ג','ד','ה','ו'];

// ================= HELPERS =================
function formatTime(v){
  if(v==null || v==='') return '';
  if(typeof v==='string' && v.includes(':')) return v.slice(0,5);
  if(typeof v==='number'){
    const t=Math.round(v*24*60);
    return String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0');
  }
  return '';
}
function parseDateSafe(v){ if(!v) return null; const d=new Date(v); if(!isNaN(d)){d.setHours(0,0,0,0);return d;} return null; }
function sameDay(a,b){return a&&b&&a.getTime()===b.getTime();}
function startOfWeek(d){const x=new Date(d);x.setDate(x.getDate()-x.getDay());x.setHours(0,0,0,0);return x;}

// ================= LOAD EXCEL =================
async function loadExcel(){
  const res=await fetch('DASHBOARD.xlsx',{cache:'no-store'});
  const buf=await res.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array'});
  const sheet=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
  rawData=buildRecords(rows);
  initFilters();
  render();
}

function buildRecords(rows){
  if(!rows || !rows.length) return [];
  const h=rows[0].map(x=>String(x||'').toLowerCase().replace(/\s+/g,''));
  return rows.slice(1).map(r=>{
    const o={}; h.forEach((k,i)=>o[k]=r[i]);
    return {
      Manager:o.manager||'',
      Instructor:o.employee||'',
      Program:o.program||'',
      School:o.school||'',
      Authority:o.municipality||o.authority||'',
      StartTime:o.starttime,
      EndTime:o.endtime,
      Dates:Array.from({length:16},(_,i)=>parseDateSafe(o['date'+(i+1)]))
    };
  });
}

// ================= FILTERS =================
function initFilters(){
  const managerSel=document.getElementById('managerFilter');
  const programSel=document.getElementById('programFilter');

  const managers=[...new Set(rawData.map(r=>r.Manager).filter(Boolean))];
  managerSel.innerHTML='<option value="">סינון לפי מנהל</option>' + managers.map(v=>`<option>${v}</option>`).join('');

  const programs=[...new Set(rawData.map(r=>r.Program).filter(Boolean))];
  programSel.innerHTML='<option value="">סינון לפי תוכנית</option>' + programs.map(v=>`<option>${v}</option>`).join('');

  managerSel.onchange=render;
  programSel.onchange=render;
}

function filteredData(){
  const m=document.getElementById('managerFilter').value;
  const p=document.getElementById('programFilter').value;
  return rawData.filter(r=>{
    if(m && r.Manager!==m) return false;
    if(p && r.Program!==p) return false;
    return true;
  });
}

// ================= RENDER =================
function render(){
  const calendarGrid=document.getElementById('calendarGrid');
  const backToMonth=document.getElementById('backToMonth');
  const navTitle=document.getElementById('navTitle');

  calendarGrid.innerHTML='';
  const data=filteredData();

  if(currentMode==='month'){
    backToMonth.style.display='none';
    renderMonth(data);
  } else {
    backToMonth.style.display='inline-block';
    renderWeek(data);
  }
}

function renderMonth(data){
  const calendarGrid=document.getElementById('calendarGrid');
  const navTitle=document.getElementById('navTitle');
  const year=currentDate.getFullYear();
  const month=currentDate.getMonth();
  navTitle.textContent=`${currentDate.toLocaleString('he-IL',{month:'long'})} ${year}`;

  const first=new Date(year,month,1);
  const last=new Date(year,month+1,0);

  // headers
  dayNames.forEach(d=>{
    const h=document.createElement('div'); h.className='meta'; h.style.textAlign='center'; h.textContent=d; calendarGrid.appendChild(h);
  });

  // padding start (skip Saturday)
  let startDay=first.getDay();
  for(let i=0;i<startDay;i++){
    if(i===6) continue;
    calendarGrid.appendChild(document.createElement('div'));
  }

  for(let day=1;day<=last.getDate();day++){
    const date=new Date(year,month,day);
    if(date.getDay()===6) continue;

    const cell=document.createElement('div'); cell.className='day';
    const header=document.createElement('div'); header.className='day-header'; header.textContent=day;
    header.onclick=()=>{currentDate=date; currentMode='week'; render();};
    cell.appendChild(header);

    data.forEach(r=>r.Dates.forEach((d,idx)=>{
      if(d&&sameDay(d,date)){
        const ev=document.createElement('div'); ev.className='event';
        ev.innerHTML=`<strong>${r.Instructor||'-'}</strong>
          <div class="meta">${r.Program||'-'} · מפגש ${idx+1}</div>
          <div class="meta">${r.School||'-'} · ${r.Authority||'-'}</div>
          <div class="meta">שעות: ${formatTime(r.StartTime)}–${formatTime(r.EndTime)}</div>`;
        cell.appendChild(ev);
      }
    }));

    calendarGrid.appendChild(cell);
  }
}

function renderWeek(data){
  const calendarGrid=document.getElementById('calendarGrid');
  const navTitle=document.getElementById('navTitle');
  const start=startOfWeek(currentDate);
  navTitle.textContent='שבוע החל מ־'+start.toLocaleDateString('he-IL');

  dayNames.forEach(d=>{
    const h=document.createElement('div'); h.className='meta'; h.style.textAlign='center'; h.textContent=d; calendarGrid.appendChild(h);
  });

  for(let i=0;i<6;i++){
    const date=new Date(start); date.setDate(start.getDate()+i);
    const cell=document.createElement('div'); cell.className='day';
    const header=document.createElement('div'); header.className='day-header'; header.textContent=date.getDate();
    cell.appendChild(header);

    data.forEach(r=>r.Dates.forEach((d,idx)=>{
      if(d&&sameDay(d,date)){
        const ev=document.createElement('div'); ev.className='event';
        ev.innerHTML=`<strong>${r.Instructor||'-'}</strong>
          <div class="meta">${r.Program||'-'} · מפגש ${idx+1}</div>
          <div class="meta">${r.School||'-'} · ${r.Authority||'-'}</div>
          <div class="meta">שעות: ${formatTime(r.StartTime)}–${formatTime(r.EndTime)}</div>`;
        cell.appendChild(ev);
      }
    }));

    calendarGrid.appendChild(cell);
  }
}

// ================= EVENTS =================
prevNav.onclick=()=>{
  if(currentMode==='month') currentDate.setMonth(currentDate.getMonth()-1);
  else currentDate.setDate(currentDate.getDate()-7);
  render();
};

nextNav.onclick=()=>{
  if(currentMode==='month') currentDate.setMonth(currentDate.getMonth()+1);
  else currentDate.setDate(currentDate.getDate()+7);
  render();
};

backToMonth.onclick=()=>{currentMode='month'; render();};
clearFilters.onclick=()=>{document.getElementById('managerFilter').value='';document.getElementById('programFilter').value='';render();};

// ================= BASIC SELF-TESTS =================
(function tests(){
  console.assert(typeof formatTime('08:30')==='string','formatTime string');
  console.assert(formatTime(0.5)==='12:00','formatTime number');
  const d=new Date(); d.setHours(0,0,0,0);
  console.assert(sameDay(d,new Date(d)),'sameDay works');
})();

loadExcel();
</script>
</body>
</html>
