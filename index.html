<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>×“×©×‘×•×¨×“ ×¤×¢×™×œ×•×ª ×•×ª×•×›× ×™×•×ª</title>

<style>
:root{
  --bg-main:#f8fafc;--bg-surface:#eef2f7;--card-bg:#ffffff;--accent:#2563eb;--accent-soft:#e0ecff;--text-main:#0f172a;--text-muted:#475569;--border:#e2e8f0;
}
body{margin:0;font-family:Assistant,system-ui,sans-serif;background:linear-gradient(180deg,var(--bg-main),var(--bg-surface));color:var(--text-main);} 
header{background:#fff;border-bottom:1px solid var(--border);} 
.header-inner{max-width:1200px;margin:auto;padding:14px;display:flex;gap:16px;align-items:center;} 
.app-logo{height:42px;} 

.controls,.nav-controls{display:flex;justify-content:center;gap:8px;margin:10px auto;flex-wrap:wrap;} 
select,button{height:32px;font-size:13px;padding:4px 10px;border-radius:8px;border:1px solid var(--border);background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.08);} 
button.active{background:var(--accent);color:#fff;}
.nav-btn{width:32px;height:32px;border-radius:999px;} 

.nav-controls{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border);padding:6px 0;}

.calendar-grid{max-width:1200px;margin:auto;padding:10px;display:grid;grid-template-columns:repeat(7,1fr);gap:12px;} 
.day{background:var(--card-bg);border-radius:14px;padding:10px;box-shadow:0 6px 16px rgba(0,0,0,.1);} 
.day.inactive{background:#f1f5f9;} 
.day-header{font-weight:700;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;} 
.badge{background:var(--accent);color:#fff;border-radius:999px;padding:0 6px;font-size:11px;}
.event{border-radius:10px;padding:8px;margin-top:6px;font-size:13px;border-left:6px solid var(--accent);} 
.meta{font-size:12px;color:var(--text-muted);} 
.calendar-grid>.meta{font-size:20px;font-weight:800;text-align:center;color:#0f172a;} 

@media(max-width:768px){
  header .header-inner{flex-direction:column;align-items:flex-start;gap:8px;}
  .controls{gap:6px;margin:6px;}
  select,button{width:100%;max-width:100%;}

  .nav-controls{flex-wrap:wrap;gap:6px;}

  .calendar-grid{grid-template-columns:1fr;padding:8px;}
  .calendar-grid>.meta{display:none;}

  .day{padding:12px;background:#ffffff;}
  .day.inactive{background:#f8fafc;}
  .day-header{font-size:16px;}
  .event{font-size:14px;}
}

.missing{color:#dc2626;font-weight:700;}
.event.holiday{background:linear-gradient(135deg,#fef9c3,#ffffff);border:2px solid #fde047;}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <img src="logo.png" class="app-logo" alt="logo">
    <div><strong>×“×©×‘×•×¨×“ ×¤×¢×™×œ×•×ª ×•×ª×•×›× ×™×•×ª</strong><br><span class="meta">×ª×¦×•×’×” ×—×•×“×©×™×ª / ×©×‘×•×¢×™×ª ×œ×¤×™ ×ª××¨×™×›×™×</span></div>
  </div>
</header>

<div class="controls">
  <select id="managerFilter"><option value="">×¡×™× ×•×Ÿ ×œ×¤×™ ×× ×”×œ</option></select>
  <select id="programFilter"><option value="">×¡×™× ×•×Ÿ ×œ×¤×™ ×ª×•×›× ×™×ª</option></select>
  <select id="employeeFilter"><option value="">×‘×—×¨ ×¢×•×‘×“</option></select>
  <button id="clearFilters">× ×§×” ×¡×™× ×•×Ÿ</button>
</div>

<div class="nav-controls">
  <button id="viewMonthBtn" class="active">×—×•×“×©</button>
  <button id="viewWeekBtn">×©×‘×•×¢</button>
  <button id="prevNav" class="nav-btn">â–¶</button>
  <span id="navTitle"></span>
  <button id="nextNav" class="nav-btn">â—€</button>
</div>

<div id="calendarGrid" class="calendar-grid"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let rawData=[];
let currentDate=new Date();currentDate.setHours(0,0,0,0);
let currentMode='month';
const dayNames=['×','×‘','×’','×“','×”','×•','×©'];

function colorForEmployee(name){
  if(!name) return '#94a3b8';
  let hash=0; for(let i=0;i<name.length;i++){ hash=name.charCodeAt(i)+((hash<<5)-hash); }
  return `hsl(${Math.abs(hash)%360},70%,55%)`;
}

const sameDay=(a,b)=>a&&b&&a.getTime()===b.getTime();
const startOfWeek=d=>{const x=new Date(d);x.setDate(x.getDate()-x.getDay());x.setHours(0,0,0,0);return x;};
const formatTime=v=>{if(!v)return'';if(typeof v==='string')return v.slice(0,5);if(typeof v==='number'){const t=Math.round(v*24*60);return String(Math.floor(t/60)).padStart(2,'0')+':'+String(t%60).padStart(2,'0');}return'';};
const parseDateSafe=v=>{if(!v)return null;const d=new Date(v);if(!isNaN(d)){d.setHours(0,0,0,0);return d;}return null;};

async function loadExcel(){
  const res=await fetch('DASHBOARD.xlsx',{cache:'no-store'});
  const buf=await res.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array'});
  const sheet=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
  rawData=buildRecords(rows);
  initFilters();
  render();
}

function buildRecords(rows){
  if(!rows.length) return [];
  const h=rows[0].map(x=>String(x||'').toLowerCase().replace(/\s+/g,''));
  return rows.slice(1).map(r=>{
    const o={}; h.forEach((k,i)=>o[k]=r[i]);
    return{Manager:o.manager||'',Employee:o.employee||'',Program:o.program||'',School:o.school||'',Authority:o.authority||'',EventType:(o.eventtype||'COURSE').toUpperCase(),StartTime:o.starttime,EndTime:o.endtime,Dates:Array.from({length:16},(_,i)=>parseDateSafe(o['date'+(i+1)]))};
  });
}

function initFilters(){
  const set=(id,arr,ph)=>{const s=document.getElementById(id);s.innerHTML=`<option value="">${ph}</option>`+arr.map(v=>`<option>${v}</option>`).join('');s.onchange=render;};
  set('managerFilter',[...new Set(rawData.map(r=>r.Manager).filter(Boolean))],'×¡×™× ×•×Ÿ ×œ×¤×™ ×× ×”×œ');
  set('programFilter',[...new Set(rawData.map(r=>r.Program).filter(Boolean))],'×¡×™× ×•×Ÿ ×œ×¤×™ ×ª×•×›× ×™×ª');
  set('employeeFilter',[...new Set(rawData.map(r=>r.Employee).filter(Boolean))],'×‘×—×¨ ×¢×•×‘×“');
}

function filteredData(){const m=managerFilter.value,p=programFilter.value,e=employeeFilter.value;return rawData.filter(r=>(!m||r.Manager===m)&&(!p||r.Program===p)&&(!e||r.Employee===e));}

function render(){
  calendarGrid.innerHTML='';
  const data=filteredData();
  viewMonthBtn.classList.toggle('active',currentMode==='month');
  viewWeekBtn.classList.toggle('active',currentMode==='week');

  // ×ª××™×“ ××¦×™×’×™× ×œ×•×— (×’× ×× ××™×Ÿ × ×ª×•× ×™×)
  if(currentMode==='week'){
    renderWeek(data);
  } else {
    renderMonth(data);
  }
}

function renderMonth(data){
  navTitle.textContent=currentDate.toLocaleString('he-IL',{month:'long',year:'numeric'});
  const y=currentDate.getFullYear(),m=currentDate.getMonth();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  dayNames.forEach(d=>calendarGrid.appendChild(Object.assign(document.createElement('div'),{className:'meta',textContent:d})));
  for(let i=0;i<first.getDay();i++) calendarGrid.appendChild(document.createElement('div'));
  for(let d=1;d<=last.getDate();d++){
    const cur=new Date(y,m,d);const cell=document.createElement('div');cell.className='day';let count=0;
    data.forEach(r=>r.Dates.forEach((dd,idx)=>{if(dd&&sameDay(dd,cur)){count++;const ev=document.createElement('div');ev.className='event';if(r.Employee)ev.style.borderLeftColor=colorForEmployee(r.Employee);if(r.EventType==='HOLIDAY'){ev.classList.add('holiday');ev.innerHTML=`<strong>ğŸ‰ ${r.Program||'×—×’'}</strong><div class="meta">××™×¨×•×¢ ×—×’</div>`;}else{const emp=r.Employee||'<span class="missing">×—×¡×¨ ×¢×•×‘×“</span>';ev.innerHTML=`<strong>${emp}</strong><div class="meta">${r.Program}</div>`;}cell.appendChild(ev);}}));
    const h=document.createElement('div');h.className='day-header';h.innerHTML=`<span>${d}</span>${count?`<span class="badge">${count}</span>`:''}`;cell.prepend(h);if(!count)cell.classList.add('inactive');calendarGrid.appendChild(cell);
  }
}

function renderWeek(data){
  const start=startOfWeek(currentDate);const end=new Date(start);end.setDate(start.getDate()+6);
  navTitle.textContent=`${start.toLocaleDateString('he-IL')} â€“ ${end.toLocaleDateString('he-IL')}`;
  dayNames.forEach(d=>calendarGrid.appendChild(Object.assign(document.createElement('div'),{className:'meta',textContent:d})));
  for(let i=0;i<7;i++){const cur=new Date(start);cur.setDate(start.getDate()+i);const cell=document.createElement('div');cell.className='day';let count=0;
    data.forEach(r=>r.Dates.forEach(dd=>{if(dd&&sameDay(dd,cur)){count++;const ev=document.createElement('div');ev.className='event';if(r.Employee)ev.style.borderLeftColor=colorForEmployee(r.Employee);cell.appendChild(ev);}}));
    const h=document.createElement('div');h.className='day-header';h.innerHTML=`<span>${cur.getDate()}</span>${count?`<span class="badge">${count}</span>`:''}`;cell.prepend(h);if(!count)cell.classList.add('inactive');calendarGrid.appendChild(cell);
  }
}

prevNav.onclick=()=>{currentDate.setDate(currentDate.getDate()-7);render();};
nextNav.onclick=()=>{currentDate.setDate(currentDate.getDate()+7);render();};
viewMonthBtn.onclick=()=>{currentMode='month';render();};
viewWeekBtn.onclick=()=>{currentMode='week';render();};
clearFilters.onclick=()=>{managerFilter.value=programFilter.value=employeeFilter.value='';render();};

loadExcel();
</script>
</body>
</html>
