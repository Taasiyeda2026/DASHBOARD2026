<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>דשבורד פעילויות</title>
<link rel="icon" href="logo.png" type="image/png" />

<style>
:root{
  --bg:#f8fafc;--card:#ffffff;--border:#e2e8f0;--text:#0f172a;--muted:#64748b;--danger:#dc2626;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}
header{background:#fff;border-bottom:1px solid var(--border)}
.header-inner{max-width:1200px;margin:auto;padding:14px;display:flex;gap:12px;align-items:center}
.app-logo{height:40px}

.controls{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin:10px}
select,button{height:32px;border:1px solid var(--border);border-radius:8px;background:#fff;padding:0 10px;cursor:pointer}
#btnMonth.active{background:#e0f2fe;border-color:#7dd3fc}
#btnWeek.active{background:#ecfeff;border-color:#67e8f9}
#btnSummary.active{background:#f0fdf4;border-color:#86efac}

.nav{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10;display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin:0;padding:10px}
.nav-modes{display:flex;gap:8px;align-items:center}
.nav-arrows{display:flex;gap:8px;align-items:center}
.nav-arrows #title{min-width:200px;text-align:center;font-weight:700}

.grid{max-width:1200px;margin:auto;padding:10px;display:grid;grid-template-columns:repeat(7,1fr);gap:12px;grid-auto-rows: 1fr;}
.day{background:var(--card);border-radius:12px;padding:8px;min-height:140px;border:1px solid var(--border); display: flex; flex-direction: column; gap: 4px;}
.day-header{font-size:11px;font-weight:700;border-bottom:1px solid var(--border);margin-bottom:4px;padding-bottom:4px;text-align:center;}

.event{padding:6px;border-radius:8px;font-size:12px;cursor:pointer;border-right:5px solid rgba(0,0,0,0.1);background:rgba(255,255,255,.9); position: relative; min-height: 55px; display: flex; flex-direction: column; justify-content: center; overflow: hidden;}
.event.missing{border:2px solid var(--danger);border-right:5px solid var(--danger);background:#fff !important}
.badge-count{background:rgba(0,0,0,0.7); color:#fff; font-size:9px; padding:1px 4px; border-radius:10px; position: absolute; top: 4px; left: 4px; font-weight:bold;}
.event-hour{font-size:10px; color:#1e293b; font-weight:bold; background:rgba(0,0,0,0.08); padding:1px 4px; border-radius:4px; align-self: flex-start; margin-bottom: 2px;}

/* side panel */
.side{position:fixed;top:0;left:0;width:380px;max-width:92%;height:100%;background:#fff;box-shadow:-6px 0 24px rgba(0,0,0,.18);transform:translateX(-100%);transition:.28s ease;z-index:50;padding:18px; overflow-y:auto;}
.side.open{transform:translateX(0)}
.side .close{position:absolute;top:12px;left:12px;border:none;background:#f1f5f9;border-radius:8px;width:32px;height:32px;font-size:20px;cursor:pointer}
.side h2{margin:0 0 6px 0;font-size:20px}
.side .subtitle{font-size:13px;color:var(--muted);margin-bottom:14px}
.side .row{display:flex;justify-content:space-between;gap:10px;margin:8px 0;font-size:14px}
.side .label{color:var(--muted);font-size:12px}
.side .value{font-weight:600}
.side .badge{display:inline-block;background:#e0f2fe;color:#0369a1;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
.group-item{background:#f8fafc; border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px;}

/* --- שינויים בעמוד הסיכום --- */
.summary-wrap{max-width:1200px;margin:auto;padding:10px;display:grid;gap:16px}
.summary-top{background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center}

.summary-split {
  display: flex;            /* שימוש ב-Flex למרכוז טוב יותר */
  justify-content: center;  /* ממרכז את התיבות במסך */
  gap: 25px;                /* רווח בין המנהלים */
  flex-wrap: wrap;          /* ירידת שורה בניידים */
  max-width: 1200px;
  margin: 0 auto;
}

.summary-col {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  
  /* קיבוע גודל התיבה */
  width: 380px;             
  min-width: 380px;
  max-width: 380px;
  
  margin: 0;                /* ביטול המרכוז העצמי של Grid */
  display: flex;
  flex-direction: column;
}

/* טיפול בטקסט ארוך בתוך התיבות בסיכום */
.summary-col .event {
  width: 100%;
  white-space: normal;      /* מאפשר לטקסט לרדת שורה */
  word-wrap: break-word;    /* שובר מילים ארוכות אם צריך */
  height: auto;
  min-height: unset;
  padding: 10px;
  margin-top: 8px;
}

/* --- התאמה מלאה לנייד --- */
@media(max-width:800px){
  /* גריד עמודה אחת */
  .grid{grid-template-columns:1fr; gap:8px; padding:6px;}

  /* סיכום - התאמה למסך קטן */
  .summary-col {
    width: 95%;
    min-width: 95%;
    max-width: 100%;
    padding: 16px;
  }

  /* פילטרים - עמודה אנכית במובייל */
  .controls {
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
    padding: 0 10px;
  }
  .controls select,
  .controls button {
    width: 100%;
    height: 40px;           /* גודל נגיש למגע */
    font-size: 14px;
  }

  /* ניווט - שתי שורות מסודרות */
  .nav {
    flex-direction: column;
    gap: 6px;
    padding: 8px 10px;
  }

  /* כפתורי מצב - שורה ראשונה, מתפרשים על כל הרוחב */
  .nav-modes {
    width: 100%;
    justify-content: center;
  }
  .nav-modes button {
    flex: 1 1 0;
    height: 38px;
    font-size: 14px;
  }
  .nav-modes select {
    height: 38px;
    font-size: 14px;
  }

  /* שורת ניווט (חיצים + כותרת) - שורה שנייה, מלא רוחב */
  .nav-arrows {
    width: 100%;
    justify-content: center;
  }
  .nav-arrows #prev,
  .nav-arrows #next {
    height: 40px;
    width: 44px;             /* גודל מינימלי נגיש למגע (44px) */
    min-width: 44px;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  .nav-arrows #title {
    font-size: 15px;
    min-width: 0;
    flex: 1 1 auto;
  }

  /* כרטיסי ימים */
  .day {
    min-height: 100px;
    padding: 6px;
  }

  /* אירועים - גודל נגיש למגע */
  .event {
    font-size: 13px;
    padding: 8px;
    min-height: 48px;
  }

  /* פאנל צד - מסך מלא במובייל */
  .side {
    width: 100%;
    max-width: 100%;
  }

  /* כותרת */
  .header-inner {
    padding: 10px;
    gap: 8px;
  }
  .app-logo {
    height: 32px;
  }

  /* סיכום - פיצול */
  .summary-split {
    gap: 12px;
  }
}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <img src="logo.png" class="app-logo" />
    <strong>דשבורד פעילויות</strong>
  </div>
</header>

<div class="controls" id="filters">
  <select id="managerFilter"><option value="">כל המנהלים</option></select>
  <select id="employeeFilter"><option value="">כל המדריכים</option></select>
  <button id="clearFilters">נקה סינון</button>
</div>

<div class="nav">
  <div class="nav-modes">
    <select id="summaryMonth" style="display:none"></select>
    <button id="btnMonth" class="active">חודש</button>
    <button id="btnWeek">שבוע</button>
    <button id="btnSummary">סיכום</button>
  </div>
  <div class="nav-arrows">
    <button id="prev" aria-label="הקודם">▶</button>
    <span id="title"></span>
    <button id="next" aria-label="הבא">◀</button>
  </div>
</div>

<div id="view"></div>

<div class="side" id="side">
  <button class="close" id="closeSide">×</button>
  <div id="sideContent"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ... כאן כל פונקציות ה-JS שלך ...
const view=document.getElementById('view');
const titleEl=document.getElementById('title');
const filtersEl=document.getElementById('filters');
const side=document.getElementById('side');
const sideContent=document.getElementById('sideContent');
const btnMonth=document.getElementById('btnMonth');
const btnWeek=document.getElementById('btnWeek');
const btnSummary=document.getElementById('btnSummary');
const managerFilter=document.getElementById('managerFilter');
const employeeFilter=document.getElementById('employeeFilter');
const summaryMonth=document.getElementById('summaryMonth');

let rawData=[];
let mode='month';
let currentDate=new Date(); currentDate.setHours(0,0,0,0);
const dayNames=['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];

const employeeColors = {
  "הנאא אבו אמזה": "#f9d3d3", "יונתן יהונתן פתייה": "#fdf1d3", "אביב בלנדר": "#d3f4f9",
  "אסיל ג'בר": "#dcd3f9", "ברקת קטעי": "#d3f9de", "אלכס זפקה": "#FFDEBD",
  "עליזה מולה": "#CCFFFF", "ליאל בן חמו": "#FEFEB4", "אפרת אוחיון": "#FFFFCC",
  "אלדר מיכאל טייב": "#A3E0FF", "הילה רוזן": "#f9d3eb", "תמר שפיר": "#EAEAEA",
  "אילנה טיטייבסקי": "#d3f9d8", "כרמית סמנדרוב": "#E8D1FF", "מיכל שכטמן": "#d3f9f4",
  "ראנה סאלח": "#f6d3f9", "סוהא סאלם": "#f9f6d3", "קרן גורביץ": "#d3eff9"
};

function getEmployeeColor(name) {
  if (!name || name.trim() === "") return "#ffffff";
  return employeeColors[name.trim()] || "#f1f5f9";
}

function formatTime(v){
  if(v==null||v==='') return '';
  if(typeof v==='number'){
    const totalMinutes = Math.round(v * 24 * 60);
    const h = String(Math.floor(totalMinutes/60)).padStart(2,'0');
    const m = String(totalMinutes%60).padStart(2,'0');
    return `${h}:${m}`;
  }
  return String(v);
}

const sameDay=(a,b)=>a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();

function parseDate(v){
  if(!v) return null;
  if(typeof v==='number'){
    const d=XLSX.SSF.parse_date_code(v);
    return d?new Date(d.y,d.m-1,d.d):null;
  }
  const d=new Date(v); return isNaN(d)?null:d;
}

function endDate(r){
  const d=r.Dates.filter(Boolean);
  return d.length?new Date(Math.max(...d.map(x=>x.getTime()))):null;
}

async function load(){
  try {
    const res=await fetch('./DASHBOARD.xlsx',{cache:'no-store'});
    const wb=XLSX.read(await res.arrayBuffer(),{type:'array'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
    const h=rows[0].map(x=>String(x).trim());
    const col=n=>h.findIndex(x=>x.toLowerCase()===n.toLowerCase());

    rawData=rows.slice(1).map(r=>{
      const g=n=>{const i=col(n); return i>-1?r[i]:''};
      const dates=[]; for(let i=1;i<=16;i++) dates.push(parseDate(g('Date'+i)));
      return{
        Manager: g('Manager'), Employee: g('Employee'), Program: g('Program'),
        School: g('School'), Authority: g('Authority'), EventType: g('EventType'),
        StartTime: formatTime(g('StartTime') || g('שעת התחלה')),
        EndTime: formatTime(g('EndTime') || g('שעת סיום')),
        End: parseDate(g('End')),
        MonthEnd: parseDate(g('MonthEnd')||g('monthend')||g('MONTHEND')),
        Dates: dates
      };
    }).filter(r=>r.Dates.some(Boolean) || r.MonthEnd);

    initFilters(); initSummaryMonths(); render();
  } catch(e) { console.error("Error loading Excel:", e); }
}

function initFilters(){
  const managers=[...new Set(rawData.map(r=>r.Manager).filter(Boolean))];
  const employees=[...new Set(rawData.map(r=>r.Employee).filter(Boolean))];
  managerFilter.innerHTML='<option value="">כל המנהלים</option>'+managers.map(v=>`<option>${v}</option>`).join('');
  employeeFilter.innerHTML='<option value="">כל המדריכים</option>'+employees.map(v=>`<option>${v}</option>`).join('');
}

function initSummaryMonths(){
  const months=[...new Set(rawData.map(r=>endDate(r)).filter(Boolean).map(d=>`${d.getFullYear()}-${d.getMonth()}`))].sort();
  summaryMonth.innerHTML=months.map(k=>{
    const [y,m]=k.split('-').map(Number);
    return `<option value="${k}">${new Date(y,m).toLocaleString('he-IL',{month:'long',year:'numeric'})}</option>`;
  }).join('');
  const todayKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
  const idx = months.indexOf(todayKey);
  if(idx >= 0) summaryMonth.selectedIndex = idx;
}

function render(){
  view.innerHTML=''; side.classList.remove('open');
  filtersEl.style.display=mode==='summary'?'none':'flex';
  summaryMonth.style.display=mode==='summary'?'inline-block':'none';
  btnMonth.classList.toggle('active',mode==='month');
  btnWeek.classList.toggle('active',mode==='week');
  btnSummary.classList.toggle('active',mode==='summary');
  if(mode==='summary') renderSummary();
  else if(mode==='week') renderWeek();
  else renderMonth();
}

function renderMonth(){
  titleEl.textContent=currentDate.toLocaleString('he-IL',{month:'long',year:'numeric'});
  const data=applyFilters();
  const grid=document.createElement('div'); grid.className='grid';
  const y=currentDate.getFullYear(),m=currentDate.getMonth();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  for(let i=0;i<first.getDay();i++) grid.appendChild(Object.assign(document.createElement('div'), {className:'day inactive'}));
  for(let d=1;d<=last.getDate();d++){ grid.appendChild(buildDay(new Date(y,m,d),data)); }
  view.appendChild(grid);
}

function renderWeek(){
  const s=new Date(currentDate); s.setDate(s.getDate()-s.getDay());
  const e=new Date(s); e.setDate(e.getDate()+6);
  titleEl.textContent=`${s.toLocaleDateString('he-IL')} – ${e.toLocaleDateString('he-IL')}`;
  const data=applyFilters();
  const grid=document.createElement('div'); grid.className='grid';
  for(let i=0;i<7;i++){
    const cur=new Date(s); cur.setDate(s.getDate()+i);
    grid.appendChild(buildDay(cur,data));
  }
  view.appendChild(grid);
}

function buildDay(date,data){
  const cell=document.createElement('div'); cell.className='day';
  cell.innerHTML=`<div class='day-header'>${date.getDate()}/${date.getMonth()+1} | ${dayNames[date.getDay()]}</div>`;
  
  const dailyPool = [];
  data.forEach(r => r.Dates.forEach((dd, i) => {
    if(sameDay(dd, date)) dailyPool.push({ ...r, meetingIdx: i + 1 });
  }));

  const groupsMap = {};
  dailyPool.forEach(ev => {
    if(ev.EventType === 'HOLIDAY') {
      const key = `holiday-${ev.Program}`;
      if(!groupsMap[key]) groupsMap[key] = { type:'holiday', time: '00:00', items:[ev] };
    } else {
      const key = `${ev.Employee}-${ev.Program}`;
      if(!groupsMap[key]) groupsMap[key] = { type:'course', time: ev.StartTime || '99:99', items:[] };
      groupsMap[key].items.push(ev);
    }
  });

  const sortedGroups = Object.values(groupsMap).sort((a, b) => a.time.localeCompare(b.time));

  sortedGroups.forEach(g => {
    const evDiv = document.createElement('div');
    const first = g.items[0];
    
    if(g.type === 'holiday') {
      evDiv.className = 'event'; evDiv.style.background = '#fee2e2';
      evDiv.innerHTML = `<strong>חג</strong> <div>${first.Program}</div>`;
    } else {
      const hasEmp = !!(first.Employee && first.Employee.trim());
      evDiv.className = 'event' + (!hasEmp ? ' missing' : '');
      evDiv.style.background = getEmployeeColor(first.Employee);
      
      const count = g.items.length > 1 ? `<span class="badge-count">x${g.items.length}</span>` : '';
      const hourStr = first.StartTime ? `<div class="event-hour">${first.StartTime}</div>` : '';
      const empName = hasEmp ? `<strong>${first.Employee}</strong>` : `<strong style="color:var(--danger)">חסר מדריך</strong>`;
      
      evDiv.innerHTML = `${count}${hourStr}${empName}<div>${first.Program}</div>`;
      evDiv.onclick = (e) => { e.stopPropagation(); openSideGrouped(g.items); };
    }
    cell.appendChild(evDiv);
  });
  return cell;
}

function openSideGrouped(items) {
  const first = items[0];
  sideContent.innerHTML = `
    <h2>${first.Program}</h2>
    <div class='subtitle'>מנהל: ${first.Manager || '—'}</div>
    <div style="border-top:1px solid var(--border); margin-top:10px; padding-top:10px;"></div>
  `;
  
  items.forEach(item => {
    const end = endDate(item);
    const timeRange = (item.StartTime || item.EndTime) ? `${item.StartTime} – ${item.EndTime}` : '—';
    const empDisplay = (item.Employee && item.Employee.trim()) ? item.Employee : `<span style="color:var(--danger); font-weight:bold;">חסר מדריך</span>`;
    
    sideContent.innerHTML += `
      <div class="group-item">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div class='badge'>מפגש ${item.meetingIdx}</div>
          <div style="background:#334155; color:#fff; padding:2px 8px; border-radius:6px; font-size:12px; font-weight:bold;">${timeRange}</div>
        </div>
        <div class='row'><span class='label'>מדריך</span><span class='value'>${empDisplay}</span></div>
        <div class='row'><span class='label'>בית ספר</span><span class='value'>${item.School || '—'}</span></div>
        <div class='row'><span class='label'>רשות</span><span class='value'>${item.Authority || '—'}</span></div>
        <div class='row'><span class='label'>סיום קורס</span><span class='value'>${end ? end.toLocaleDateString('he-IL') : '—'}</span></div>
      </div>
    `;
  });
  side.classList.add('open');
}

function applyFilters(){
  return rawData.filter(r=>(!managerFilter.value||r.Manager===managerFilter.value)&&(!employeeFilter.value||r.Employee===employeeFilter.value));
}

function renderSummary(){
  if(!summaryMonth.value) return;
  const courses = rawData.filter(r=>(String(r.EventType||'').trim().toUpperCase() === 'COURSE' && r.End));
  const [y,m] = summaryMonth.value.split('-').map(Number);
  const monthStart = new Date(y,m,1);
  const activeTotal = courses.filter(r => parseDate(r.End) >= monthStart).length;
  titleEl.textContent = monthStart.toLocaleString('he-IL',{month:'long',year:'numeric'});

  const wrap = document.createElement('div'); wrap.className = 'summary-wrap';
  wrap.innerHTML = `<div class='summary-top'><div style='font-size:14px;color:#64748b'>סה"כ קורסים פעילים</div><div style='font-size:40px;font-weight:800'>${activeTotal}</div></div>`;

  const managers = [...new Set(courses.map(r=>r.Manager).filter(Boolean))];
  const split = document.createElement('div'); split.className = 'summary-split';

  managers.forEach(mgr=>{
    const mgrCourses = courses.filter(r=>r.Manager === mgr);
    const mgrActive = mgrCourses.filter(r => parseDate(r.End) >= monthStart).length;
    const mgrEndedThisMonth = mgrCourses.filter(r=>{
        const d = parseDate(r.MonthEnd || r.End);
        return d && d.getFullYear()===y && d.getMonth()===m;
    }).sort((a,b)=>parseDate(a.End)-parseDate(b.End));

    const col = document.createElement('div'); col.className = 'summary-col';
    col.innerHTML = `
      <div style="text-align:center;margin-bottom:10px">
        <div style="font-size:13px;color:#64748b">קורסים פעילים</div>
        <div style="font-size:26px;font-weight:800">${mgrActive}</div>
      </div>
      <div class="manager-header" style="text-align:center; border-bottom:2px solid #f59e0b; margin-bottom:12px;"><h3>${mgr}</h3></div>
      <div class="event" style="text-align:center;cursor:pointer;font-weight:400"
           onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='none'?'block':'none'">
        קורסים שמסתיימים החודש: ${mgrEndedThisMonth.length}
      </div>
      <div style="display:none">
        ${mgrEndedThisMonth.length ? mgrEndedThisMonth.map(r=>{
          const empName = (r.Employee && r.Employee.trim()) ? r.Employee : `<span style="color:var(--danger)">חסר מדריך</span>`;
          return `
          <div class='event' style="background:${getEmployeeColor(r.Employee)}">
            <strong>${r.Program}</strong>
            <div><small>מדריך:</small> ${empName}</div>
            <div><small>בית ספר:</small> ${r.School||'—'}</div>
            <div><small>תאריך סיום:</small> ${parseDate(r.End).toLocaleDateString('he-IL')}</div>
          </div>`;
        }).join('') : '<div style="text-align:center;color:#94a3b8;padding:10px;">אין קורסים המסתיימים החודש</div>'}
      </div>`;
    split.appendChild(col);
  });
  wrap.appendChild(split); view.appendChild(wrap);
}

document.getElementById('prev').onclick=()=>{
  if(mode==='summary') {
    summaryMonth.selectedIndex=Math.max(0,summaryMonth.selectedIndex-1);
  } else if(mode==='week') {
    currentDate.setDate(currentDate.getDate()-7);
  } else {
    currentDate.setMonth(currentDate.getMonth()-1);
  }
  render();
};
document.getElementById('next').onclick=()=>{
  if(mode==='summary') {
    summaryMonth.selectedIndex=Math.min(summaryMonth.options.length-1,summaryMonth.selectedIndex+1);
  } else if(mode==='week') {
    currentDate.setDate(currentDate.getDate()+7);
  } else {
    currentDate.setMonth(currentDate.getMonth()+1);
  }
  render();
};
btnMonth.onclick=()=>{mode='month';render();};
btnWeek.onclick=()=>{mode='week';render();};
btnSummary.onclick=()=>{mode='summary';render();};
managerFilter.onchange=render; 
employeeFilter.onchange=render;
document.getElementById('clearFilters').onclick=()=>{managerFilter.value='';employeeFilter.value='';render();};
summaryMonth.onchange=render;
document.getElementById('closeSide').onclick=()=>side.classList.remove('open');

window.addEventListener('load', load);
</script>
</body>
</html>
