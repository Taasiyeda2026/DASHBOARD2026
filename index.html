<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- ×‘×™×˜×•×œ Cache ××œ× -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>×“×©×‘×•×¨×“ ×¤×¢×™×œ×•×™×•×ª</title>

<link rel="icon" href="icon-192.png" type="image/png" />
<link rel="apple-touch-icon" href="icon-192.png" />
<link rel="manifest" href="manifest.json" />

<meta name="theme-color" content="#ffffff" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="×“×©×‘×•×¨×“" />

<style>

:root{
  --bg:#f8fafc;--card:#ffffff;--border:#e2e8f0;--text:#0f172a;--muted:#64748b;--danger:#dc2626;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text);overflow-x:hidden}
header{background:#fff;border-bottom:1px solid var(--border)}
.header-inner{max-width:1200px;margin:auto;padding:14px;display:flex;gap:12px;align-items:center}
.app-logo{height:40px}

.controls{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin:10px}
.instructors-count-title{max-width:1200px;margin:18px auto 0;padding:0 10px;text-align:right;font-size:16px;font-weight:700;}
select,button{height:32px;border:1px solid var(--border);border-radius:8px;background:#fff;padding:0 10px;cursor:pointer}
.today-star {
  width: 38px;
  height: 38px;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  cursor: pointer;
  border: none;
  clip-path: polygon(
    50% 0%,
    61% 35%,
    98% 35%,
    68% 57%,
    79% 91%,
    50% 70%,
    21% 91%,
    32% 57%,
    2% 35%,
    39% 35%
  );
  transition: all 0.18s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.today-star:hover {
  transform: scale(1.1) rotate(8deg);
  box-shadow: 0 8px 20px rgba(245,158,11,0.4);
  filter: brightness(1.05);
}

.today-star:active {
  transform: scale(0.92);
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  filter: brightness(0.9);
}
.today-calendar {
  width: 38px;
  height: 38px;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  cursor: pointer;
  border: none;
  clip-path: inset(0 round 10px);
  transition: all 0.18s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.today-calendar::before {
  content: "ğŸ“…";
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  width:100%;
  height:100%;
}

.today-calendar:hover {
  transform: scale(1.1);
  box-shadow: 0 8px 20px rgba(37,99,235,0.4);
}

.today-calendar:active {
  transform: scale(0.92);
}
#btnMonth.active{background:#e0f2fe;border-color:#7dd3fc}
#btnWeek.active{background:#ecfeff;border-color:#67e8f9}
#btnSummary.active{background:#f0fdf4;border-color:#86efac}
#btnInstructors.active{background:#fef3c7;border-color:#fcd34d}

.nav{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10;display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin:0;padding:10px}
.nav-modes{display:flex;gap:8px;align-items:center}
.nav-arrows{display:flex;gap:8px;align-items:center}
.nav-arrows #title{min-width:200px;text-align:center;font-weight:700}

#view{
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 20px 150px 20px;
}

.grid{max-width:1200px;margin:auto;padding:10px;display:grid;grid-template-columns:repeat(7,1fr);gap:12px;grid-auto-rows: 1fr;}
.day{background:var(--card);border-radius:12px;padding:8px;min-height:140px;border:1px solid var(--border); display: flex; flex-direction: column; gap: 4px;}
.day.today{
  border:2px solid #3b82f6 !important;
  box-shadow:0 0 0 3px rgba(59,130,246,0.15);
}
.day.empty{min-height:auto;opacity:0.5;}
.day.inactive{min-height:auto;opacity:0.3;}
.day-header{font-size:11px;font-weight:700;border-bottom:1px solid var(--border);margin-bottom:4px;padding-bottom:4px;text-align:center;}

.event{padding:6px;border-radius:8px;font-size:12px;cursor:pointer;border-right:5px solid rgba(0,0,0,0.1);background:rgba(255,255,255,.9); position: relative; min-height: 55px; display: flex; flex-direction: column; justify-content: center; overflow: hidden;}
.event.missing{border:2px solid var(--danger);border-right:5px solid var(--danger);background:#fff !important}
.badge-count{background:rgba(0,0,0,0.7); color:#fff; font-size:9px; padding:1px 4px; border-radius:10px; position: absolute; top: 4px; left: 4px; font-weight:bold;}
.event-hour{font-size:10px; color:#0f172a; font-weight:600; background:rgba(255,255,255,0.65); backdrop-filter:blur(2px); padding:2px 6px; border-radius:6px; align-self:flex-start; margin-bottom:4px;}

/* side panel */
.side{position:fixed;top:0;left:0;width:380px;max-width:92%;height:100%;background:#fff;box-shadow:-6px 0 24px rgba(0,0,0,.18);transform:translateX(-100%);transition:.28s ease;z-index:50;padding:60px 18px 18px 18px; overflow-y:auto;}
.side.open{transform:translateX(0)}
.side .close,
.side-close{position:absolute;top:16px;left:16px;z-index:1000;background:#fff;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none}
.side h2{margin:0 0 6px 0;font-size:20px}
.side .subtitle{font-size:13px;color:var(--muted);margin-bottom:14px}
.side .row{display:flex;justify-content:space-between;gap:10px;margin:8px 0;font-size:14px}
.side .label{color:var(--muted);font-size:12px}
.side .value{font-weight:600}
.side .badge{display:inline-block;background:#e0f2fe;color:#0369a1;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
.group-item{background:#f8fafc; border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px;}

.instructor-header{
  background:linear-gradient(135deg,#f8fafc,#e2e8f0);
  padding:18px;
  border-radius:16px;
  margin-bottom:16px;
}

.instructor-name{
  font-size:20px;
  font-weight:800;
  margin-bottom:10px;
  color:#0f172a;
}

.instructor-badges{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.instructor-badges .badge{
  padding:6px 12px;
  border-radius:999px;
  font-size:13px;
  font-weight:600;
}

.badge.type{
  background:#e0f2fe;
  color:#0369a1;
}

.badge.days{
  background:#dcfce7;
  color:#166534;
}

.badge.courses{
  background:#fef3c7;
  color:#92400e;
}

.course-card{
  background:#ffffff;
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
  transition:0.2s;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.course-card span{
  line-height:1.7;
}

.course-card:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 18px rgba(0,0,0,0.08);
}

.course-title{
  font-weight:700;
  font-size:15px;
  margin-bottom:8px;
}

.course-meta{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  font-size:13px;
  color:#475569;
}

/* --- ×©×™× ×•×™×™× ×‘×¢××•×“ ×”×¡×™×›×•× --- */
.summary-wrap{max-width:1200px;margin:auto;padding:10px;display:grid;gap:16px}
.summary-top{background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center}

.summary-split{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,300px));
  gap:24px;
  justify-content:center;
  align-items:start;
}

.summary-col{
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:20px;
  padding:24px;
  box-shadow:0 10px 25px rgba(0,0,0,0.06);
  transition:0.2s ease;
  cursor:pointer;
  text-align:center;
}

.summary-col:hover{
  transform:translateY(-4px);
  box-shadow:0 16px 35px rgba(0,0,0,0.12);
}

/* ×˜×™×¤×•×œ ×‘×˜×§×¡×˜ ××¨×•×š ×‘×ª×•×š ×”×ª×™×‘×•×ª ×‘×¡×™×›×•× */
.summary-col .event {
  width: 100%;
  white-space: normal;
  word-wrap: break-word;
  height: auto;
  min-height: unset;
  padding: 10px;
  margin-top: 8px;
}

/* ===== SUMMARY KPI ===== */

.summary-wrap{
  max-width:1200px;
  margin:auto;
  padding:30px 20px;
  display:grid;
  gap:30px;
}

.summary-top{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
}

.kpi-card{
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:18px;
  padding:26px;
  box-shadow:0 8px 20px rgba(0,0,0,0.06);
  text-align:center;
}

.kpi-label{
  font-size:13px;
  color:#64748b;
  margin-bottom:8px;
  font-weight:600;
}

.kpi-value{
  font-size:40px;
  font-weight:800;
  color:#0f172a;
}

/* ===== MANAGER CARDS ===== */

.summary-col h3{
  margin:0 0 12px 0;
  font-size:18px;
  font-weight:800;
  border-bottom:2px solid #f59e0b;
  padding-bottom:6px;
}

.summary-course-box{
  margin-top:12px;
  padding:14px 16px;
  border-radius:14px;
  background:linear-gradient(135deg,#f8fafc,#eef2f7);
  font-size:14px;
  font-weight:600;
  color:#0f172a;
  box-shadow:inset 0 0 0 1px #e2e8f0;
}

.manager-overlay-bg{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.55);
  backdrop-filter:blur(4px);
  z-index:99;
  animation:fadeIn .2s ease;
}

@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}

.manager-details-overlay{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  z-index:100;
  width:100%;
  max-width:600px;
  background:linear-gradient(135deg,#ffffff,#f8fafc);
  border-radius:22px;
  box-shadow:0 25px 70px rgba(0,0,0,0.35);
  padding:28px 30px;
  animation:popIn .2s ease;
  max-height:80vh;
  overflow:auto;
}

@keyframes popIn{
  from{
    opacity:0;
    transform:translate(-50%,-48%) scale(.96);
  }
  to{
    opacity:1;
    transform:translate(-50%,-50%) scale(1);
  }
}

.manager-course-card{
  background:#ffffff;
  border-radius:16px;
  padding:18px 20px;
  margin-bottom:18px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
  transition:.2s;
}

.manager-course-card:last-child{
  margin-bottom:0;
}

.manager-course-title{
  font-weight:800;
  font-size:16px;
  margin-bottom:8px;
  color:#0f172a;
}

.manager-course-meta{
  font-size:14px;
  color:#475569;
  line-height:1.8;
}

/* --- ×”×ª×××” ××œ××” ×œ× ×™×™×“ --- */
@media(max-width:800px){
  header{
    padding: 10px 12px !important;
  }

  .nav{
    padding: 8px 10px !important;
  }

  #view{
    padding: 10px !important;
  }

  .grid{grid-template-columns:1fr !important; gap:10px !important; padding:6px;}

  .grid{
    grid-auto-rows: auto !important;
  }

  .day{
    min-height: auto !important;
    height: auto !important;
    padding: 10px !important;
  }

  .summary-split{
    grid-template-columns:1fr;
    justify-items:center;
    gap:18px;
  }

  .summary-col{
    width:92%;
    max-width:380px;
    min-width:unset;
  }

  .summary-wrap{
    padding: 0 !important;
  }

  .controls {
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
    padding: 0 10px;
  }
  .controls select,
  .controls button {
    width: 100%;
    height: 40px;
    font-size: 14px;
  }

  .instructors-count-title{
    margin-top:12px;
    font-size:15px;
    padding:0 12px;
  }

  .nav {
    flex-direction: column !important;
    gap: 8px !important;
  }

  #btnMonth,
  #btnWeek{
    display: none !important;
  }

  .nav-modes {
    width: 100%;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    gap: 10px !important;
    margin-bottom: 8px !important;
  }

  #btnSummary,
  #btnInstructors{
    flex: 0 1 auto !important;
    min-width: 120px;
    height: 38px;
    font-size: 14px;
    border-radius: 14px;
  }

  .nav-modes button {
    flex: 1 1 0;
    font-size: 12.5px;
    height: 40px;
    padding: 0 8px;
  }
  .nav-modes select {
    height: 38px;
    font-size: 14px;
  }

  .nav-arrows {
    width: 100%;
    justify-content: center;
  }
  .nav-arrows #prev,
  .nav-arrows #next {
    width: 40px;
    height: 36px;
    font-size: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  .nav-arrows #title {
    font-size: 14px;
    min-width: 0;
    flex: 1 1 auto;
  }

  .day {
    min-height: auto !important;
    padding: 10px !important;
  }
  .day.empty, .day.inactive {
    display: none !important;
  }

  .event {
    font-size: 14px !important;
    padding: 10px !important;
    min-height: 52px !important;
  }

  .side {
    width: 100% !important;
    max-width: 100% !important;
  }

  .instructors-grid,
  #view > div[style*="grid-template-columns: repeat(auto-fill,minmax(180px,1fr))"]{
    grid-template-columns: 1fr !important;
    gap: 14px !important;
  }

  .instructors-grid > div,
  #view > div[style*="grid-template-columns: repeat(auto-fill,minmax(180px,1fr))"] > div{
    min-height: 130px;
    padding: 18px !important;
    border-radius: 18px;
  }

  .instructors-grid > div div:first-child,
  #view > div[style*="grid-template-columns: repeat(auto-fill,minmax(180px,1fr))"] > div div:first-child{
    font-size: 18px !important;
  }

  .instructors-grid > div div:nth-child(2),
  #view > div[style*="grid-template-columns: repeat(auto-fill,minmax(180px,1fr))"] > div div:nth-child(2){
    font-size: 34px !important;
  }

  .header-inner {
    padding: 10px;
    gap: 8px;
  }
  .app-logo {
    height: 32px;
  }

}

@media(max-width:600px){

  body, .controls, .instructor-header, .course-card, .course-meta, .instructor-badges{
    overflow-wrap:anywhere;
  }

  .side{
    width:100%;
    max-width:100%;
  }

  .instructor-header{
    padding:14px;
  }

  .instructor-name{
    font-size:18px;
  }

  .instructor-badges{
    flex-direction:column;
    gap:6px;
  }

  .course-meta{
    grid-template-columns:1fr;
  }

  .course-card{
    padding:14px;
  }
}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <img src="logo.png" class="app-logo" />
    <strong>×“×©×‘×•×¨×“ ×¤×¢×™×œ×•×™×•×ª</strong>
  </div>
</header>

<div class="controls" id="filters">
  <select id="managerFilter"><option value="">×›×œ ×”×× ×”×œ×™×</option></select>
  <select id="employeeFilter"><option value="">×›×œ ×”××“×¨×™×›×™×</option></select>
  <button id="clearFilters">× ×§×” ×¡×™× ×•×Ÿ</button>
</div>

<div class="nav">
  <div class="nav-modes">
    <select id="summaryMonth" style="display:none"></select>
    <button id="btnMonth" class="active">×—×•×“×©</button>
    <button id="btnWeek">×©×‘×•×¢</button>
    <button id="btnSummary">×¡×™×›×•×</button>
    <button id="btnInstructors">××“×¨×™×›×™×</button>
  </div>
  <div class="nav-arrows">
    <button id="prev" aria-label="×”×§×•×“×">â–¶</button>
    <button id="goToday" class="today-star" title="×”×™×•×" aria-label="×”×™×•×"></button>
    <button id="goCalendar" class="today-calendar" aria-label="×—×•×“×©" title="×—×•×“×©"></button>
    <span id="title"></span>
    <button id="next" aria-label="×”×‘×">â—€</button>
  </div>
</div>

<div id="view"></div>

<div class="side" id="side">
  <button class="close" id="closeSide">Ã—</button>
  <div id="sideContent"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>

const view=document.getElementById('view');
const titleEl=document.getElementById('title');
const filtersEl=document.getElementById('filters');
const side=document.getElementById('side');
const sideContent=document.getElementById('sideContent');
const btnMonth=document.getElementById('btnMonth');
const btnWeek=document.getElementById('btnWeek');
const btnSummary=document.getElementById('btnSummary');
const btnInstructors=document.getElementById('btnInstructors');
const goCalendar = document.getElementById('goCalendar');
const managerFilter=document.getElementById('managerFilter');
const employeeFilter=document.getElementById('employeeFilter');
const summaryMonth=document.getElementById('summaryMonth');

let rawData=[];
let dataRange=null;
let mode='month';
let currentDate=new Date(); currentDate.setHours(0,0,0,0);
const dayNames=['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];

const employeeColors = {
  "×”× ×× ××‘×• ×××–×”": "#f9d3d3", "×™×•× ×ª×Ÿ ×™×”×•× ×ª×Ÿ ×¤×ª×™×™×”": "#fdf1d3", "××‘×™×‘ ×‘×œ× ×“×¨": "#d3f4f9",
  "××¡×™×œ ×’'×‘×¨": "#dcd3f9", "×‘×¨×§×ª ×§×˜×¢×™": "#d3f9de", "××œ×›×¡ ×–×¤×§×”": "#FFDEBD",
  "×¢×œ×™×–×” ××•×œ×”": "#CCFFFF", "×œ×™××œ ×‘×Ÿ ×—××•": "#FEFEB4", "××¤×¨×ª ××•×—×™×•×Ÿ": "#FFFFCC",
  "××œ×“×¨ ××™×›××œ ×˜×™×™×‘": "#A3E0FF", "×”×™×œ×” ×¨×•×–×Ÿ": "#f9d3eb", "×ª××¨ ×©×¤×™×¨": "#EAEAEA",
  "××™×œ× ×” ×˜×™×˜×™×™×‘×¡×§×™": "#d3f9d8", "×›×¨××™×ª ×¡×× ×“×¨×•×‘": "#E8D1FF", "××™×›×œ ×©×›×˜××Ÿ": "#d3f9f4",
  "×¨×× ×” ×¡××œ×—": "#f6d3f9", "×¡×•×”× ×¡××œ×": "#f9f6d3", "×§×¨×Ÿ ×’×•×¨×‘×™×¥": "#d3eff9"
};

function getEmployeeColor(name) {
  if (!name || name.trim() === "") return "#ffffff";
  return employeeColors[name.trim()] || "#f1f5f9";
}

function formatTime(v){
  if(v==null||v==='') return '';
  if(typeof v==='number'){
    const totalMinutes = Math.round(v * 24 * 60);
    const h = String(Math.floor(totalMinutes/60)).padStart(2,'0');
    const m = String(totalMinutes%60).padStart(2,'0');
    return `${h}:${m}`;
  }
  return String(v);
}

const sameDay=(a,b)=>a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();

function parseDate(v){
  if(!v) return null;
  if(typeof v==='number'){
    const d=XLSX.SSF.parse_date_code(v);
    return d?new Date(d.y,d.m-1,d.d):null;
  }
  const d=new Date(v); return isNaN(d)?null:d;
}

function isCourse(r){
  return String(r.EventType || '').trim().toUpperCase() === 'COURSE';
}

function isCourseActiveInMonth(r, year, month){
  return isCourse(r) &&
    r.Dates.some(d =>
      d &&
      d.getFullYear() === year &&
      d.getMonth() === month
    );
}

function isCourseEndingInMonth(r, year, month){
  if(!isCourse(r) || !r.End) return false;
  const d = parseDate(r.End);
  return d &&
         d.getFullYear() === year &&
         d.getMonth() === month;
}

function getBusiestWeekWorkDays(courses, year, month){
  const weeksMap = {};

  courses.forEach(r=>{
    if(String(r.EventType || '').trim().toUpperCase() !== 'COURSE') return;

    r.Dates.forEach(d=>{
      if(
        d &&
        d.getFullYear() === year &&
        d.getMonth() === month
      ){
        const weekStart = new Date(d);
        weekStart.setDate(d.getDate() - d.getDay());
        weekStart.setHours(0,0,0,0);

        const key = weekStart.toISOString();

        if(!weeksMap[key]){
          weeksMap[key] = new Set();
        }

        weeksMap[key].add(d.toDateString());
      }
    });
  });

  let maxDays = 0;

  Object.values(weeksMap).forEach(set=>{
    if(set.size > maxDays){
      maxDays = set.size;
    }
  });

  return maxDays;
}

function clampDateToDataRange(date){
  const d = new Date(date);
  d.setHours(0,0,0,0);
  if(!dataRange) return d;
  if(d < dataRange.min) return new Date(dataRange.min);
  if(d > dataRange.max) return new Date(dataRange.max);
  return d;
}

function weekOverlapsDataRange(date){
  if(!dataRange) return true;
  const weekStart = new Date(date);
  weekStart.setDate(date.getDate() - date.getDay());
  weekStart.setHours(0,0,0,0);

  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  weekEnd.setHours(0,0,0,0);

  return weekEnd >= dataRange.min && weekStart <= dataRange.max;
}

function getMinAllowedMonth(){
  const today = new Date();
  today.setHours(0,0,0,0);
  return new Date(today.getFullYear(), today.getMonth()-1, 1);
}

function canGoPrev(){
  if(mode === 'summary'){
    if(summaryMonth.selectedIndex <= 0) return false;

    const prevOption = summaryMonth.options[summaryMonth.selectedIndex-1].value;
    const [y,m] = prevOption.split('-').map(Number);
    const prevDate = new Date(y,m,1);

    return prevDate >= getMinAllowedMonth();
  }
  if(!dataRange) return false;

  if(mode === 'month'){
    const temp = new Date(currentDate);
    temp.setMonth(temp.getMonth()-1);

    return temp >= getMinAllowedMonth();
  }

  if(mode === 'week'){
    const temp = new Date(currentDate);
    temp.setDate(temp.getDate()-7);

    const minAllowed = getMinAllowedMonth();

    return temp >= minAllowed;
  }

  return false;
}

function canGoNext(){
  if(mode === 'summary') return summaryMonth.selectedIndex < summaryMonth.options.length-1;
  if(!dataRange) return false;

  if(mode === 'month'){
    const temp = new Date(currentDate);
    temp.setMonth(temp.getMonth()+1);
    return temp.getFullYear() < dataRange.max.getFullYear() ||
      (temp.getFullYear() === dataRange.max.getFullYear() && temp.getMonth() <= dataRange.max.getMonth());
  }

  if(mode === 'week'){
    const temp = new Date(currentDate);
    temp.setDate(temp.getDate()+7);
    return weekOverlapsDataRange(temp);
  }

  return false;
}

function updateNavButtons(){
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  prevBtn.disabled = !canGoPrev();
  nextBtn.disabled = !canGoNext();
}

function updateModeButtons(){
  btnMonth.classList.remove('active');
  btnWeek.classList.remove('active');
  btnSummary.classList.remove('active');
  btnInstructors.classList.remove('active');

  if(mode === 'month') btnMonth.classList.add('active');
  if(mode === 'week') btnWeek.classList.add('active');
  if(mode === 'summary') btnSummary.classList.add('active');
  if(mode === 'instructors') btnInstructors.classList.add('active');
}

function endDate(r){
  const d=r.Dates.filter(Boolean);
  return d.length?new Date(Math.max(...d.map(x=>x.getTime()))):null;
}

function getDataDateRange(){
  const allDates = rawData.flatMap(r => r.Dates.filter(Boolean));

  if(allDates.length === 0) return null;

  const min = new Date(Math.min(...allDates.map(d=>d.getTime())));
  const max = new Date(Math.max(...allDates.map(d=>d.getTime())));

  min.setHours(0,0,0,0);
  max.setHours(0,0,0,0);

  return { min, max };
}

async function load(){
  try {
    const res = await fetch('./DASHBOARD.xlsx?v=' + new Date().getTime());
    const wb=XLSX.read(await res.arrayBuffer(),{type:'array'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
    const h=rows[0].map(x=>String(x).trim());
    const col=n=>h.findIndex(x=>x.toLowerCase()===n.toLowerCase());

    rawData=rows.slice(1).map(r=>{
      const g=n=>{const i=col(n); return i>-1?r[i]:''};
      const dates=[]; for(let i=1;i<=16;i++) dates.push(parseDate(g('Date'+i)));
      return{
        Manager: g('Manager'), Employee: g('Employee'), Program: g('Program'),
        School: g('School'), Authority: g('Authority'), EventType: g('EventType'),
        EmploymentType: g('EmploymentType'),
        StartTime: formatTime(g('StartTime') || g('×©×¢×ª ×”×ª×—×œ×”')),
        EndTime: formatTime(g('EndTime') || g('×©×¢×ª ×¡×™×•×')),
        End: parseDate(g('End')),
        Dates: dates
      };
    }).filter(r=>r.Dates.some(Boolean));

    window.dataRange = getDataDateRange();
    dataRange = window.dataRange;

    initFilters(); initSummaryMonths();
    currentDate = clampDateToDataRange(new Date());
    mode='month';
    render();
  } catch(e) { console.error("Error loading Excel:", e); }
}

function initFilters(){
  const managers=[...new Set(rawData.map(r=>r.Manager).filter(Boolean))];
  const employees=[...new Set(rawData.map(r=>r.Employee).filter(Boolean))];
  managerFilter.innerHTML='<option value="">×›×œ ×”×× ×”×œ×™×</option>'+managers.map(v=>`<option>${v}</option>`).join('');
  employeeFilter.innerHTML='<option value="">×›×œ ×”××“×¨×™×›×™×</option>'+employees.map(v=>`<option>${v}</option>`).join('');
}

function initSummaryMonths(){
  const months=[...new Set(rawData.flatMap(r=>r.Dates.filter(Boolean)).map(d=>`${d.getFullYear()}-${d.getMonth()}`))].sort();
  summaryMonth.innerHTML=months.map(k=>{
    const [y,m]=k.split('-').map(Number);
    return `<option value="${k}">${new Date(y,m).toLocaleString('he-IL',{month:'long',year:'numeric'})}</option>`;
  }).join('');
  const todayKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
  const idx = months.indexOf(todayKey);
  if(idx >= 0) summaryMonth.selectedIndex = idx;
}

function render(){

  view.innerHTML='';
  side.classList.remove('open');

  if(mode === 'summary' || mode === 'instructors'){
    filtersEl.style.display = 'none';
  }else{
    filtersEl.style.display = 'flex';
  }

  const isMobile = window.innerWidth < 800;

  if(isMobile && (mode === 'month' || mode === 'week')){
    renderMobileMonth();
  }
  else if(mode==='summary'){
    renderSummary();
  }
  else if(mode==='week'){
    renderWeek();
  }
  else if(mode==='instructors'){
    renderInstructors();
  }
  else{
    renderMonth();
  }

  updateNavButtons();
  updateModeButtons();

  if(mode === 'month'){
    goCalendar.style.display = 'none';
  } else {
    goCalendar.style.display = 'inline-flex';
  }
}

function renderMonth(){
  titleEl.textContent=currentDate.toLocaleString('he-IL',{month:'long',year:'numeric'});
  const data=applyFilters();
  const grid=document.createElement('div'); grid.className='grid';
  const y=currentDate.getFullYear(),m=currentDate.getMonth();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  for(let i=0;i<first.getDay();i++) grid.appendChild(Object.assign(document.createElement('div'), {className:'day inactive'}));
  for(let d=1;d<=last.getDate();d++){ grid.appendChild(buildDay(new Date(y,m,d),data)); }
  view.appendChild(grid);
}

function renderWeek(){
  const s=new Date(currentDate); s.setDate(s.getDate()-s.getDay());
  const e=new Date(s); e.setDate(e.getDate()+6);
  titleEl.textContent=`${s.toLocaleDateString('he-IL')} â€“ ${e.toLocaleDateString('he-IL')}`;
  const data=applyFilters();
  const grid=document.createElement('div'); grid.className='grid';
  for(let i=0;i<7;i++){
    const cur=new Date(s); cur.setDate(s.getDate()+i);
    grid.appendChild(buildDay(cur,data));
  }
  view.appendChild(grid);
}

function renderMobileMonth(){

  const y = currentDate.getFullYear();
  const m = currentDate.getMonth();

  titleEl.textContent =
    new Date(y,m,1).toLocaleString('he-IL',{month:'long',year:'numeric'});

  const data = applyFilters();

  const first = new Date(y,m,1);
  const last  = new Date(y,m+1,0);

  const start = new Date(first);
  start.setDate(first.getDate() - first.getDay());
  start.setHours(0,0,0,0);

  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.gap = '14px';
  container.style.padding = '10px';

  let cursor = new Date(start);

  while(cursor <= last){

    const weekStart = new Date(cursor);
    const weekEnd   = new Date(cursor);
    weekEnd.setDate(weekStart.getDate()+6);

    const box = document.createElement('div');
    box.style.background = '#fff';
    box.style.borderRadius = '18px';
    box.style.padding = '16px';
    box.style.boxShadow = '0 6px 16px rgba(0,0,0,0.06)';
    box.style.cursor = 'pointer';

    box.innerHTML = `
      <div style="font-weight:800;font-size:15px;text-align:center">
        ${weekStart.toLocaleDateString('he-IL')} â€“ ${weekEnd.toLocaleDateString('he-IL')}
      </div>
    `;

    box.onclick = ()=>{
      renderMobileWeekDetail(weekStart, data);
    };

    container.appendChild(box);

    cursor.setDate(cursor.getDate()+7);
  }

  view.appendChild(container);
}

function renderMobileWeekDetail(weekStart, data){

  view.innerHTML='';

  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate()+6);

  titleEl.textContent =
    `${weekStart.toLocaleDateString('he-IL')} â€“ ${weekEnd.toLocaleDateString('he-IL')}`;

  const container = document.createElement('div');
  container.style.display='flex';
  container.style.flexDirection='column';
  container.style.gap='12px';
  container.style.padding='10px';

  for(let i=0;i<7;i++){
    const date = new Date(weekStart);
    date.setDate(weekStart.getDate()+i);
    container.appendChild(buildDay(date,data));
  }

  view.appendChild(container);
}

function buildDay(date,data){
  const cell=document.createElement('div'); cell.className='day';
  cell.innerHTML=`<div class='day-header'>${date.getDate()}/${date.getMonth()+1} | ${dayNames[date.getDay()]}</div>`;
  if(sameDay(date, new Date())){
    cell.classList.add('today');
  }

  const dailyPool = [];
  data.forEach(r => r.Dates.forEach((dd, i) => {
    if(sameDay(dd, date)) dailyPool.push({ ...r, meetingIdx: i + 1 });
  }));

  const groupsMap = {};
  dailyPool.forEach(ev => {
    if(ev.EventType === 'HOLIDAY') {
      const key = `holiday-${ev.Program}`;
      if(!groupsMap[key]) groupsMap[key] = { type:'holiday', time: '00:00', items:[ev] };
    } else {
      const key = `${ev.Employee}-${ev.Program}`;
      if(!groupsMap[key]) groupsMap[key] = { type:'course', time: ev.StartTime || '99:99', items:[] };
      groupsMap[key].items.push(ev);
    }
  });

  const sortedGroups = Object.values(groupsMap).sort((a, b) => a.time.localeCompare(b.time));

  if(sortedGroups.length === 0) cell.classList.add('empty');

  sortedGroups.forEach(g => {
    const evDiv = document.createElement('div');
    const first = g.items[0];

    if(g.type === 'holiday') {
      evDiv.className = 'event'; evDiv.style.background = '#fee2e2';
      evDiv.innerHTML = `<strong>×—×’</strong> <div>${first.Program}</div>`;
    } else {
      const hasEmp = !!(first.Employee && first.Employee.trim());
      evDiv.className = 'event' + (!hasEmp ? ' missing' : '');
      evDiv.style.background = getEmployeeColor(first.Employee);

      const count = g.items.length > 1 ? `<span class="badge-count">x${g.items.length}</span>` : '';
      const hourStr = first.StartTime ? `<div class="event-hour">${first.StartTime}</div>` : '';
      const empName = hasEmp ? `<strong>${first.Employee}</strong>` : `<strong style="color:var(--danger)">×—×¡×¨ ××“×¨×™×š</strong>`;

      evDiv.innerHTML = `${count}${hourStr}${empName}<div>${first.Program}</div>`;
      evDiv.onclick = (e) => { e.stopPropagation(); openSideGrouped(g.items); };
    }
    cell.appendChild(evDiv);
  });
  return cell;
}

function openSideGrouped(items) {
  const first = items[0];
  sideContent.innerHTML = `
    <h2>${first.Program}</h2>
    <div class='subtitle'>×× ×”×œ: ${first.Manager || 'â€”'}</div>
    <div style="border-top:1px solid var(--border); margin-top:10px; padding-top:10px;"></div>
  `;

  items.forEach(item => {
    const end = endDate(item);
    const timeRange = (item.StartTime || item.EndTime) ? `${item.StartTime} â€“ ${item.EndTime}` : 'â€”';
    const empDisplay = (item.Employee && item.Employee.trim()) ? item.Employee : `<span style="color:var(--danger); font-weight:bold;">×—×¡×¨ ××“×¨×™×š</span>`;

    sideContent.innerHTML += `
      <div class="group-item">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div class='badge'>××¤×’×© ${item.meetingIdx}</div>
          <div style="background:#334155; color:#fff; padding:2px 8px; border-radius:6px; font-size:12px; font-weight:bold;">${timeRange}</div>
        </div>
        <div class='row'><span class='label'>××“×¨×™×š</span><span class='value'>${empDisplay}</span></div>
        <div class='row'><span class='label'>×‘×™×ª ×¡×¤×¨</span><span class='value'>${item.School || 'â€”'}</span></div>
        <div class='row'><span class='label'>×¨×©×•×ª</span><span class='value'>${item.Authority || 'â€”'}</span></div>
        <div class='row'><span class='label'>×¡×™×•× ×§×•×¨×¡</span><span class='value'>${end ? end.toLocaleDateString('he-IL') : 'â€”'}</span></div>
      </div>
    `;
  });
  side.classList.add('open');
}

function applyFilters(){
  return rawData.filter(r=>(!managerFilter.value||r.Manager===managerFilter.value)&&(!employeeFilter.value||r.Employee===employeeFilter.value));
}

function getCourseStartDate(r){
  if(!r.Dates || !r.Dates.length) return null;

  const validDates = r.Dates.filter(d => d);
  if(validDates.length === 0) return null;

  return new Date(Math.min(...validDates.map(d => d.getTime())));
}

function renderSummary(){
  const selectedValue = summaryMonth.value;

  let currentYear;
  let currentMonth;

  if(selectedValue){
    const [y,m] = selectedValue.split('-').map(Number);
    currentYear = y;
    currentMonth = m;
  } else {
    const today = new Date();
    currentYear = today.getFullYear();
    currentMonth = today.getMonth();
  }

  const currentMonthStart = new Date(currentYear, currentMonth, 1);

  // ×›×œ ×”×§×•×¨×¡×™×
  const courses = rawData.filter(isCourse);

  // ×¤×¢×™×œ×™× ×‘×—×•×“×© ×”× ×‘×—×¨
  const activeThisMonth = rawData.filter(r => {
    if(String(r.EventType || '').trim().toUpperCase() !== 'COURSE')
      return false;

    for(let i=0;i<16;i++){
      const d = r.Dates[i];
      if(
        d &&
        d.getFullYear() === currentYear &&
        d.getMonth() === currentMonth
      ){
        return true;
      }
    }

    return false;
  }).length;

  // ×¢×ª×™×“×™×™× ××”×—×•×“×© ×”×‘× ×•×”×œ××”
  const totalFutureCourses = courses.filter(r => {
    if(String(r.EventType || '').trim().toUpperCase() !== 'COURSE')
      return false;

    const startDate = getCourseStartDate(r);
    if(!startDate) return false;

    return startDate.getMonth() > currentMonth;
  }).length;

  const totalEndedCourses = courses.filter(r => {
    const end = endDate(r);
    if(!end) return false;
    return end.getMonth() === currentMonth;
  }).length;

  const totalCourses = activeThisMonth + totalFutureCourses;

  titleEl.textContent = currentMonthStart.toLocaleString('he-IL',{month:'long',year:'numeric'});

  const wrap = document.createElement('div'); wrap.className = 'summary-wrap';
  wrap.innerHTML = `
    <div class="summary-top">

      <div class="kpi-card">
        <div class="kpi-label">×¡×”"×› ×§×•×¨×¡×™× ×¤×¢×™×œ×™×</div>
        <div class="kpi-value">${totalCourses}</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">×¤×¢×™×œ×™× ×”×—×•×“×©</div>
        <div class="kpi-value">${activeThisMonth}</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">×§×•×¨×¡×™× ×¢×ª×™×“×™×™×</div>
        <div class="kpi-value">${totalFutureCourses}</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">×§×•×¨×¡×™× ×©×”×¡×ª×™×™××•</div>
        <div class="kpi-value">${totalEndedCourses}</div>
      </div>

    </div>
  `;

  const managers = [...new Set(courses.map(r=>r.Manager).filter(Boolean))];
  const split = document.createElement('div'); split.className = 'summary-split';

  managers.forEach(mgr=>{
    const mgrCourses = courses.filter(r=>r.Manager === mgr);
    const mgrActive = mgrCourses.filter(r =>
      isCourseActiveInMonth(r, currentYear, currentMonth)
    ).length;
    const mgrEndedThisMonth = mgrCourses.filter(r => {
      const end = endDate(r);
      return end && end.getMonth() === currentMonth;
    }).sort((a,b)=>endDate(a)-endDate(b));

    const col = document.createElement('div'); col.className = 'summary-col';
    col.innerHTML = `
      <div style="text-align:center;margin-bottom:10px">
        <div style="font-size:13px;color:#64748b">×§×•×¨×¡×™× ×¤×¢×™×œ×™×</div>
        <div style="font-size:26px;font-weight:800">${mgrActive}</div>
      </div>
      <div class="manager-header" style="text-align:center; border-bottom:2px solid #f59e0b; margin-bottom:12px;"><h3>${mgr}</h3></div>
      <div class="summary-course-box">
        ×§×•×¨×¡×™× ×©××¡×ª×™×™××™× ×”×—×•×“×©: ${mgrEndedThisMonth.length}
      </div>`;

    col.onclick = () => {
      document.querySelectorAll('.manager-overlay-bg, .manager-details-overlay')
        .forEach(el=>el.remove());

      const overlayBg = document.createElement('div');
      overlayBg.className = 'manager-overlay-bg';
      document.body.appendChild(overlayBg);

      const details = document.createElement('div');
      details.className = 'manager-details-overlay';

      details.innerHTML = `
        <h3>${mgr}</h3>
        ${
          mgrEndedThisMonth.length
            ? mgrEndedThisMonth.map(r=>{
                const empName = (r.Employee && r.Employee.trim())
                  ? r.Employee
                  : `<span style="color:#dc2626;font-weight:700">×—×¡×¨ ××“×¨×™×š</span>`;

                return `
                  <div class="manager-course-card">
                    <div class="manager-course-title">${r.Program}</div>
                    <div class="manager-course-meta">
                      ğŸ‘¤ ××“×¨×™×š: ${empName}<br>
                      ğŸ« ×‘×™×ª ×¡×¤×¨: ${r.School || 'â€”'}<br>
                      ğŸŒ ×¨×©×•×ª: ${r.Authority || 'â€”'}<br>
                      ğŸ“… ×ª××¨×™×š ×¡×™×•×: ${endDate(r) ? endDate(r).toLocaleDateString('he-IL') : 'â€”'}
                    </div>
                  </div>
                `;
              }).join('')
            : '<div style="color:#94a3b8">××™×Ÿ ×§×•×¨×¡×™× ×”××¡×ª×™×™××™× ×”×—×•×“×©</div>'
        }
      `;

      document.body.appendChild(details);

      overlayBg.onclick = ()=>{
        overlayBg.remove();
        details.remove();
      };
    };

    split.appendChild(col);
  });
  wrap.appendChild(split); view.appendChild(wrap);
}

function getUniqueInstructorMonths(){
  const monthsMap = new Map();
  const minAllowed = getMinAllowedMonth();
  rawData.forEach(r=>{
    r.Dates.forEach(d=>{
      if(!d) return;
      const year = d.getFullYear();
      const month = d.getMonth();
      const key = `${year}-${String(month+1).padStart(2,'0')}`;
      if(!monthsMap.has(key)){
        monthsMap.set(key,{year,month});
      }
    });
  });

  return [...monthsMap.entries()]
    .sort((a,b)=>
      (a[1].year - b[1].year) ||
      (a[1].month - b[1].month)
    )
    .map(([,obj])=>obj)
    .filter(obj =>
      new Date(obj.year,obj.month,1) >= minAllowed
    )
    .map(({year,month})=>({
      value:`${year}-${String(month+1).padStart(2,'0')}`,
      label:new Date(year,month,1)
        .toLocaleDateString('he-IL',{month:'long',year:'numeric'})
    }));
}

function renderInstructors(){

  titleEl.textContent = "××“×¨×™×›×™×";

  const managers=[...new Set(rawData.map(r=>r.Manager).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'he'));
  const selectedManager = renderInstructors.selectedManager || '';

  const controls = document.createElement('div');
  controls.className = 'controls';
  controls.style.margin = '10px auto 0';
  controls.style.maxWidth = '1200px';

  const managerSelect = document.createElement('select');
  managerSelect.innerHTML = '<option value="">×›×œ ×”×× ×”×œ×™×</option>' + managers.map(v=>`<option value="${v}">${v}</option>`).join('');
  managerSelect.value = selectedManager;
  managerSelect.onchange = () => {
    renderInstructors.selectedManager = managerSelect.value;
    render();
  };
  controls.appendChild(managerSelect);

  const monthSelect = document.createElement('select');
  const monthOptions = getUniqueInstructorMonths();
  monthSelect.innerHTML = monthOptions
    .map(opt=>`<option value="${opt.value}">${opt.label}</option>`)
    .join('');

  const todayValue =
    `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;

  if(!renderInstructors.selectedMonthValue){

    if(monthOptions.some(opt=>opt.value === todayValue)){
      renderInstructors.selectedMonthValue = todayValue;
    }
    else if(monthOptions.length > 0){
      renderInstructors.selectedMonthValue = monthOptions[0].value;
    }

  }

  monthSelect.value = renderInstructors.selectedMonthValue;
  monthSelect.onchange = () => {
    renderInstructors.selectedMonthValue = monthSelect.value;
    render();
  };
  controls.appendChild(monthSelect);

  view.appendChild(controls);

  let selectedMonth = currentDate.getMonth();
  let selectedYear = currentDate.getFullYear();

  const selectedMonthValue = renderInstructors.selectedMonthValue;

  const [y,m] = selectedMonthValue.split('-').map(Number);
  selectedYear = y;
  selectedMonth = m - 1;

  const instructorsMap = {};
  const missingInstructorCourses = [];
  const allActiveCourses = [];

  rawData.forEach(r => {
    if(!isCourse(r)) return;
    if(!isCourseActiveInMonth(r, selectedYear, selectedMonth)) return;

    if(selectedManager && r.Manager !== selectedManager) return;

    allActiveCourses.push(r);

    if(!r.Employee || !r.Employee.trim()){
      missingInstructorCourses.push(r);
      return;
    }

    if(!instructorsMap[r.Employee]){
      instructorsMap[r.Employee] = [];
    }
    instructorsMap[r.Employee].push(r);
  });

  const names = Object.keys(instructorsMap)
    .sort((a,b)=> instructorsMap[b].length - instructorsMap[a].length || a.localeCompare(b,'he'));

  const totalCourses = allActiveCourses.length;

  const summaryHeader = document.createElement('div');
  summaryHeader.style.textAlign = 'center';
  summaryHeader.style.margin = '10px 0 20px 0';
  summaryHeader.style.fontSize = '16px';
  summaryHeader.style.fontWeight = '700';
  summaryHeader.style.lineHeight = '1.8';

  summaryHeader.innerHTML = `
    ×›××•×ª ××“×¨×™×›×™×: ${names.length}<br>
    ×›××•×ª ×§×•×¨×¡×™×: ${totalCourses}
  `;

  view.appendChild(summaryHeader);

  if(names.length===0 && missingInstructorCourses.length===0){
    const empty = document.createElement('div');
    empty.style.textAlign = 'center';
    empty.style.padding = '40px';
    empty.style.color = '#94a3b8';
    empty.textContent = '×œ× × ××¦××• ××“×¨×™×›×™× ×¤×¢×™×œ×™×';
    view.appendChild(empty);
    return;
  }

  const grid = document.createElement('div');
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = 'repeat(auto-fill,minmax(180px,1fr))';
  grid.style.gap = '16px';
  grid.style.maxWidth = '1200px';
  grid.style.margin = '20px auto';
  grid.style.padding = '10px';

  if(missingInstructorCourses.length > 0){
    const box = document.createElement('div');
    box.style.background = '#ffffff';
    box.style.border = '2px solid var(--danger)';
    box.style.borderRadius = '14px';
    box.style.padding = '16px';
    box.style.cursor = 'pointer';
    box.style.boxShadow = '0 4px 10px rgba(0,0,0,0.05)';
    box.style.display = 'flex';
    box.style.flexDirection = 'column';
    box.style.alignItems = 'center';
    box.style.justifyContent = 'center';
    box.style.textAlign = 'center';
    box.style.minHeight = '140px';

    box.innerHTML = `
      <div style="font-weight:800;font-size:18px;margin-bottom:10px;color:var(--danger)">
        ×—×¡×¨ ××“×¨×™×š
      </div>
      <div style="font-size:32px;font-weight:900;color:var(--danger)">
        ${missingInstructorCourses.length}
      </div>
      <div style="font-size:13px;color:#64748b;margin-top:6px">
        ×ª×•×›× ×™×•×ª ×¤×¢×™×œ×•×ª
      </div>
    `;

    box.onclick = ()=> openInstructorModal("×—×¡×¨ ××“×¨×™×š", missingInstructorCourses, selectedMonth, selectedYear);

    grid.appendChild(box);
  }

  names.forEach(name=>{
    const box = document.createElement('div');
    box.style.background = getEmployeeColor(name);
    box.style.border = '1px solid var(--border)';
    box.style.borderRadius = '16px';
    box.style.padding = '14px';
    box.style.cursor = 'pointer';
    box.style.boxShadow = '0 4px 10px rgba(0,0,0,0.05)';
    box.style.transition = '0.2s';
    box.style.display = 'flex';
    box.style.flexDirection = 'column';
    box.style.alignItems = 'center';
    box.style.justifyContent = 'center';
    box.style.textAlign = 'center';
    box.style.minHeight = '140px';

    box.onmouseenter = ()=> box.style.transform='scale(1.03)';
    box.onmouseleave = ()=> box.style.transform='scale(1)';

    box.innerHTML = `
      <div style="font-weight:800;font-size:18px;margin-bottom:10px">
        ${name}
      </div>
      <div style="font-size:32px;font-weight:900">
        ${instructorsMap[name].length}
      </div>
      <div style="font-size:13px;color:#475569;margin-top:6px">
        ×§×•×¨×¡×™× ×¤×¢×™×œ×™×
      </div>
    `;

    box.onclick = ()=> openInstructorModal(name, instructorsMap[name], selectedMonth, selectedYear);

    grid.appendChild(box);
  });

  view.appendChild(grid);
}

function openInstructorModal(name, courses, selectedMonth, selectedYear){

  const month = selectedMonth ?? currentDate.getMonth();
  const year  = selectedYear ?? currentDate.getFullYear();

  function normalize(d){
    const n = new Date(d);
    n.setHours(0,0,0,0);
    return n;
  }

  const weeks = {};

  courses.forEach(r=>{

    if(!isCourse(r)) return;

    r.Dates.forEach(d=>{

      if(!d) return;

      const date = normalize(d);

      if(
        date.getFullYear() === selectedYear &&
        date.getMonth() === selectedMonth
      ){

        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - date.getDay());
        weekStart.setHours(0,0,0,0);

        const key = weekStart.toISOString();

        if(!weeks[key]){
          weeks[key] = new Set();
        }

        weeks[key].add(date.toDateString());
      }

    });

  });

  let maxDays = 0;

  Object.values(weeks).forEach(set=>{
    if(set.size > maxDays){
      maxDays = set.size;
    }
  });

  const totalWorkDays = maxDays;
  const employmentType = courses[0]?.EmploymentType || 'â€”';

  sideContent.innerHTML = `
    <div class="instructor-header">
      <div class="instructor-name">${name}</div>
      <div class="instructor-badges">
        <span class="badge type">${employmentType}</span>
        <span class="badge days">${totalWorkDays} ×™××™ ×¢×‘×•×“×” ×‘×©×‘×•×¢</span>
        <span class="badge courses">${courses.length} ×§×•×¨×¡×™×</span>
      </div>
    </div>
  `;

  courses.forEach(r=>{

    const end = endDate(r);

    const startDate = r.Dates && r.Dates[0]
      ? r.Dates[0].toLocaleDateString('he-IL')
      : 'â€”';

    const endDateFormatted = end
      ? end.toLocaleDateString('he-IL')
      : 'â€”';

    sideContent.innerHTML += `
      <div class="course-card">

        <div style="
          font-weight:800;
          font-size:16px;
          padding:8px 12px;
          border-radius:10px;
          background:${getEmployeeColor(name)};
        ">
          ${r.Program || 'â€”'}
        </div>

        <div>
          <span style="font-weight:700;color:#0f172a;">×‘×™×ª ×¡×¤×¨:</span> ${r.School || 'â€”'}<br>
          <span style="font-weight:700;color:#0f172a;">×¨×©×•×ª:</span> ${r.Authority || 'â€”'}
        </div>

        <div>
          <span style="font-weight:700;color:#0f172a;">
            ×ª××¨×™×›×™ ×¤×¢×™×œ×•×ª
          </span>
          (${startDate}) - (${endDateFormatted})
        </div>

        <div style="color:#475569; font-weight:600;">
          ×× ×”×œ: ${r.Manager || 'â€”'}
        </div>

      </div>
    `;
  });

  side.classList.add('open');
}

document.getElementById('prev').onclick = ()=>{
  if(!canGoPrev()) return;

  if(mode==='summary'){
    summaryMonth.selectedIndex = Math.max(0, summaryMonth.selectedIndex-1);
  }
  else if(mode==='week'){
    const temp = new Date(currentDate);
    temp.setDate(temp.getDate()-7);

    if(temp >= getMinAllowedMonth()){
      currentDate = temp;
    }
  }
  else if(mode==='month'){
    const temp = new Date(currentDate);
    temp.setMonth(temp.getMonth()-1);

    if(temp >= getMinAllowedMonth()){
      currentDate = temp;
    }
  }

  render();
};

document.getElementById('next').onclick = ()=>{
  if(!canGoNext()) return;

  if(mode==='summary'){
    summaryMonth.selectedIndex = Math.min(summaryMonth.options.length-1, summaryMonth.selectedIndex+1);
  }
  else if(mode==='week'){
    const temp = new Date(currentDate);
    temp.setDate(temp.getDate()+7);

    const weekStart = new Date(temp);
    weekStart.setDate(temp.getDate() - temp.getDay());
    weekStart.setHours(0,0,0,0);

    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    weekEnd.setHours(0,0,0,0);

    if(dataRange && weekEnd >= dataRange.min && weekStart <= dataRange.max){
      currentDate = temp;
    }
  }
  else if(mode==='month'){
    const temp = new Date(currentDate);
    temp.setMonth(temp.getMonth()+1);

    if(dataRange){
      const maxMonth = new Date(dataRange.max.getFullYear(), dataRange.max.getMonth(), 1);
      if(temp <= maxMonth){
        currentDate = temp;
      }
    }
  }

  render();
};

btnMonth.onclick = ()=>{
  mode='month';
  currentDate = clampDateToDataRange(new Date());
  render();
};
btnWeek.onclick = ()=>{
  mode='week';
  currentDate = clampDateToDataRange(new Date());
  render();
};
btnSummary.onclick = ()=>{
  mode='summary';
  render();
};
btnInstructors.onclick = ()=>{
  mode='instructors';
  render();
};
goCalendar.onclick = ()=>{
  mode = 'month';
  currentDate = clampDateToDataRange(new Date());
  render();
};
document.getElementById('goToday').onclick = ()=>{
  const today = new Date();
  today.setHours(0,0,0,0);

  currentDate = clampDateToDataRange(today);

  if(mode === 'summary'){
    const key = `${today.getFullYear()}-${today.getMonth()}`;
    const options = [...summaryMonth.options].map(o=>o.value);
    const index = options.indexOf(key);
    if(index >= 0){
      summaryMonth.selectedIndex = index;
    }
  }

  if(mode === 'instructors'){
    renderInstructors.selectedMonthValue =
      `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
  }

  render();
};

managerFilter.onchange=render;
employeeFilter.onchange=render;
document.getElementById('clearFilters').onclick=()=>{managerFilter.value='';employeeFilter.value='';render();};
summaryMonth.onchange=render;
document.getElementById('closeSide').onclick=()=>side.classList.remove('open');

window.addEventListener('load', load);
</script>
</body>
</html>
