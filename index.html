<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>דשבורד פעילויות</title>
<link rel="icon" href="logo.png" type="image/png">
<style>
:root{--bg-main:#f8fafc;--bg-surface:#eef2f7;--card-bg:#ffffff;--accent:#2563eb;--text-main:#0f172a;--text-muted:#475569;--border:#e2e8f0;--danger:#dc2626;}
body{margin:0;font-family:system-ui;background:linear-gradient(180deg,var(--bg-main),var(--bg-surface));color:var(--text-main);} 
header{background:#fff;border-bottom:1px solid var(--border);} 
.header-inner{max-width:1200px;margin:auto;padding:14px;display:flex;gap:16px;align-items:center;} 
.app-logo{height:42px;} 
.controls,.nav-controls{display:flex;justify-content:center;gap:8px;margin:10px auto;flex-wrap:wrap;} 
select,button{height:32px;font-size:13px;padding:4px 10px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer;}
.nav-btn{width:32px;height:32px;border-radius:999px;background:#fef9c3;border-color:#fde047;font-weight:700;}
.nav-controls{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:6px 0;}
.calendar-grid{max-width:1200px;margin:auto;padding:10px;display:grid;gap:12px;}
.day{background:var(--card-bg);border-radius:14px;padding:10px;box-shadow:0 6px 16px rgba(0,0,0,.08);} 
.day-header{font-size:13px;font-weight:700;text-align:center;border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:8px;}
.event{border-radius:10px;padding:8px;margin-top:6px;font-size:13px;border-right:3px solid var(--accent);background:#fff;} 
.event.missing{border:2px solid var(--danger);} 
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <img src="logo.png" class="app-logo" alt="לוגו">
    <div><strong>דשבורד פעילויות</strong></div>
  </div>
</header>
<div class="controls">
  <select id="managerFilter"><option value="">סינון לפי מנהל</option></select>
  <select id="employeeFilter"><option value="">סינון לפי מדריך</option></select>
  <select id="monthFilter"><option value="">כל החודשים</option></select>
  <button id="clearFilters">נקה סינונים</button>
</div>
<div class="nav-controls">
  <button id="viewMonthBtn">חודש</button>
  <button id="viewWeekBtn">שבוע</button>
  <button id="viewSummaryBtn">סיכום</button>
  <button id="prevNav" class="nav-btn">▶</button>
  <span id="navTitle" style="min-width:180px;text-align:center;font-weight:bold"></span>
  <button id="nextNav" class="nav-btn">◀</button>
</div>
<div id="calendarGrid" class="calendar-grid"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let rawData=[],mode='month',currentDate=new Date();
const managerFilter=document.getElementById('managerFilter');
const employeeFilter=document.getElementById('employeeFilter');
const monthFilter=document.getElementById('monthFilter');
const grid=document.getElementById('calendarGrid');
const navTitle=document.getElementById('navTitle');
function parseDate(v){if(!v)return null;if(typeof v==='number'){const d=XLSX.SSF.parse_date_code(v);return new Date(d.y,d.m-1,d.d);}const d=new Date(v);return isNaN(d)?null:d;}
async function load(){const res=await fetch('./DASHBOARD.xlsx',{cache:'no-store'});const wb=XLSX.read(await res.arrayBuffer(),{type:'array'});const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:''});const h=rows[0];rawData=rows.slice(1).map(r=>{const get=n=>r[h.findIndex(x=>String(x).toLowerCase()===n.toLowerCase())]||'';const dates=[...Array(16)].map((_,i)=>parseDate(get('date'+(i+1))));return{Program:get('Program'),Employee:get('Employee'),Manager:get('Manager'),School:get('School'),Dates:dates};}).filter(r=>r.Dates.some(d=>d));initFilters();render();}
function initFilters(){managerFilter.innerHTML='<option value="">סינון לפי מנהל</option>'+[...new Set(rawData.map(r=>r.Manager).filter(Boolean))].map(v=>`<option>${v}</option>`).join('');employeeFilter.innerHTML='<option value="">סינון לפי מדריך</option>'+[...new Set(rawData.map(r=>r.Employee).filter(Boolean))].map(v=>`<option>${v}</option>`).join('');const months=[...new Set(rawData.flatMap(r=>r.Dates.filter(Boolean).map(d=>d.getFullYear()+'-'+(d.getMonth()+1))))].sort();monthFilter.innerHTML='<option value="">כל החודשים</option>'+months.map(k=>{const[y,m]=k.split('-');return`<option value="${k}">${new Date(y,m-1).toLocaleString('he-IL',{month:'long',year:'numeric'})}</option>`}).join('');}
function applyFilters(){return rawData.filter(r=>{if(managerFilter.value&&r.Manager!==managerFilter.value)return false;if(employeeFilter.value&&r.Employee!==employeeFilter.value)return false;return true;});}
function render(){grid.innerHTML='';if(mode==='summary'){renderSummary(applyFilters());return;}navTitle.textContent=currentDate.toLocaleString('he-IL',{month:'long',year:'numeric'});}
function renderSummary(data){
  navTitle.textContent='סיכום';
  grid.style.gridTemplateColumns='1fr';
  grid.innerHTML='';

  // ===== סיכום כולל =====
  const overall=document.createElement('div');
  overall.className='day';
  overall.innerHTML=`
    <div class="day-header">סיכום כולל</div>
    <div style="display:flex;justify-content:center;gap:80px;align-items:center">
      <div style="text-align:center">
        <div style="font-size:46px;font-weight:800">${data.length}</div>
        <div style="color:#475569">סה"כ קורסים</div>
      </div>
    </div>`;
  grid.appendChild(overall);

  // ===== חלוקה לפי מנהלים (2 בלבד) =====
  const byManager={};
  data.forEach(r=>{
    (byManager[r.Manager||'ללא מנהל']=byManager[r.Manager||'ללא מנהל']||[]).push(r);
  });

  const managers=Object.keys(byManager).slice(0,2);
  const wrap=document.createElement('div');
  wrap.style.display='grid';
  wrap.style.gridTemplateColumns='1fr 1fr';
  wrap.style.gap='16px';
  grid.appendChild(wrap);

  managers.forEach(manager=>{
    const list=byManager[manager];
    const card=document.createElement('div');
    card.className='day';

    card.innerHTML=`
      <div class="day-header">${manager}</div>
      <div style="text-align:center;margin-bottom:12px">
        <div style="font-size:38px;font-weight:800">${list.length}</div>
        <div style="color:#475569">קורסים</div>
      </div>
      <div style="display:grid;gap:6px">
        ${list.map(r=>{
          const dates=r.Dates.filter(Boolean);
          const end=dates.length ? new Date(Math.max(...dates.map(d=>d.getTime()))).toLocaleDateString('he-IL') : '—';
          return `<div class="event ${!r.Employee?'missing':''}">
            <strong>${r.Program}</strong><br>
            <small>${r.Employee||'חסר מדריך'} · ${r.School||''}</small><br>
            <small>סיום: ${end}</small>
          </div>`;
        }).join('')}
      </div>`;

    wrap.appendChild(card);
  });
}

managerFilter.onchange=render;employeeFilter.onchange=render;monthFilter.onchange=()=>{mode='summary';render();};document.getElementById('viewMonthBtn').onclick=()=>{mode='month';render();};document.getElementById('viewWeekBtn').onclick=()=>{mode='week';render();};document.getElementById('viewSummaryBtn').onclick=()=>{mode='summary';render();};document.getElementById('prevNav').onclick=()=>{currentDate.setMonth(currentDate.getMonth()-1);render();};document.getElementById('nextNav').onclick=()=>{currentDate.setMonth(currentDate.getMonth()+1);render();};document.getElementById('clearFilters').onclick=()=>{managerFilter.value='';employeeFilter.value='';monthFilter.value='';render();};
load();
</script>
</body>
</html>
