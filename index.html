<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>דשבורד פעילויות</title>
<link rel="icon" href="logo.png" type="image/png" />

<style>
:root{
  --bg:#f8fafc;--card:#ffffff;--border:#e2e8f0;--text:#0f172a;--muted:#64748b;--danger:#dc2626;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}
header{background:#fff;border-bottom:1px solid var(--border)}
.header-inner{max-width:1200px;margin:auto;padding:14px;display:flex;gap:12px;align-items:center}
.app-logo{height:40px}

.controls,.nav{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin:10px}
select,button{height:32px;border:1px solid var(--border);border-radius:8px;background:#fff;padding:0 10px;cursor:pointer}
#btnMonth.active{background:#e0f2fe;border-color:#7dd3fc}
#btnWeek.active{background:#ecfeff;border-color:#67e8f9}
#btnSummary.active{background:#f0fdf4;border-color:#86efac}

.nav{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}

.grid{max-width:1200px;margin:auto;padding:10px;display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
.day{background:var(--card);border-radius:12px;padding:8px;min-height:120px;border:1px solid var(--border)}
.day-header{font-size:12px;font-weight:700;border-bottom:1px solid var(--border);margin-bottom:6px;padding-bottom:4px;text-align:center}
.event{padding:6px;border-radius:8px;margin-top:6px;font-size:13px;cursor:pointer;border-right:5px solid #999;background:rgba(255,255,255,.9)}
.event.missing{border:2px solid var(--danger);border-right:5px solid var(--danger);background:#fff}

/* side panel */
.side{position:fixed;top:0;left:0;width:340px;max-width:90%;height:100%;background:#fff;box-shadow:-4px 0 18px rgba(0,0,0,.2);transform:translateX(-100%);transition:.25s ease;z-index:50;padding:16px}
.side.open{transform:translateX(0)}
.side .close{position:absolute;top:10px;left:10px;border:none;background:none;font-size:20px;cursor:pointer}
.side h2{margin-top:0}
.side .row{margin:6px 0;font-size:14px}

/* summary */
.summary-wrap{max-width:1200px;margin:auto;padding:10px;display:grid;gap:16px}
.summary-top{background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center}
.summary-split{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.summary-col{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px}

@media(max-width:800px){.grid{grid-template-columns:1fr}.summary-split{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <img src="logo.png" class="app-logo" />
    <strong>דשבורד פעילויות</strong>
  </div>
</header>

<div class="controls" id="filters">
  <select id="managerFilter"><option value="">כל המנהלים</option></select>
  <select id="employeeFilter"><option value="">כל המדריכים</option></select>
  <button id="clearFilters">נקה סינון</button>
</div>

<div class="nav">
  <select id="summaryMonth" style="display:none"></select>
  <button id="btnMonth" class="active">חודש</button>
  <button id="btnWeek">שבוע</button>
  <button id="btnSummary">סיכום</button>
  <button id="prev">▶</button>
  <span id="title" style="min-width:200px;text-align:center;font-weight:700"></span>
  <button id="next">◀</button>
</div>

<div id="view"></div>

<div class="side" id="side">
  <button class="close" id="closeSide">×</button>
  <div id="sideContent"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ======================
// DATA + STATE
// ======================
const view=document.getElementById('view');
const titleEl=document.getElementById('title');
const filtersEl=document.getElementById('filters');
const side=document.getElementById('side');
const sideContent=document.getElementById('sideContent');

const btnMonth=document.getElementById('btnMonth');
const btnWeek=document.getElementById('btnWeek');
const btnSummary=document.getElementById('btnSummary');
const btnPrev=document.getElementById('prev');
const btnNext=document.getElementById('next');

const managerFilter=document.getElementById('managerFilter');
const employeeFilter=document.getElementById('employeeFilter');
const clearFilters=document.getElementById('clearFilters');
const summaryMonth=document.getElementById('summaryMonth');

let rawData=[];
let mode='month';
let currentDate=new Date(); currentDate.setHours(0,0,0,0);

const dayNames=['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];

// ======================
// HELPERS
// ======================
const sameDay=(a,b)=>a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();

function parseDate(v){
  if(!v) return null;
  if(typeof v==='number'){
    const d=XLSX.SSF.parse_date_code(v);
    return d?new Date(d.y,d.m-1,d.d):null;
  }
  const d=new Date(v); return isNaN(d)?null:d;
}

function endDate(r){
  const d=r.Dates.filter(Boolean);
  return d.length?new Date(Math.max(...d.map(x=>x.getTime()))):null;
}

function colorFor(name){
  if(!name) return {bg:'#fff',border:'#dc2626'};
  let h=0; for(const c of name) h=c.charCodeAt(0)+((h<<5)-h);
  const hue=Math.abs(h)%360;
  return {bg:`hsla(${hue},70%,90%,.8)`,border:`hsl(${hue},70%,45%)`};
}

// ======================
// LOAD EXCEL
// ======================
async function load(){
  const res=await fetch('./DASHBOARD.xlsx',{cache:'no-store'});
  const wb=XLSX.read(await res.arrayBuffer(),{type:'array'});
  const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:''});
  const h=rows[0].map(x=>String(x));
  const col=n=>h.findIndex(x=>x.toLowerCase()===n.toLowerCase());

  rawData=rows.slice(1).map(r=>{
    const g=n=>{const i=col(n); return i>-1?r[i]:''};
    const dates=[]; for(let i=1;i<=16;i++) dates.push(parseDate(g('Date'+i)));
    return{
      Manager:g('Manager'),Employee:g('Employee'),Program:g('Program'),
      School:g('School'),Authority:g('Authority'),EventType:g('EventType'),Dates:dates
    };
  }).filter(r=>r.Dates.some(Boolean));

  initFilters();
  initSummaryMonths();
  render();
}

function initFilters(){
  const managers=[...new Set(rawData.map(r=>r.Manager).filter(Boolean))];
  const employees=[...new Set(rawData.map(r=>r.Employee).filter(Boolean))];
  managerFilter.innerHTML='<option value="">כל המנהלים</option>'+managers.map(v=>`<option>${v}</option>`).join('');
  employeeFilter.innerHTML='<option value="">כל המדריכים</option>'+employees.map(v=>`<option>${v}</option>`).join('');
}

function initSummaryMonths(){
  const months=[...new Set(rawData.map(r=>endDate(r)).filter(Boolean).map(d=>`${d.getFullYear()}-${d.getMonth()}`))].sort();
  summaryMonth.innerHTML=months.map(k=>{
    const [y,m]=k.split('-').map(Number);
    return `<option value="${k}">${new Date(y,m).toLocaleString('he-IL',{month:'long',year:'numeric'})}</option>`;
  }).join('');
}

// ======================
// RENDER
// ======================
function render(){
  view.innerHTML='';
  side.classList.remove('open');

  filtersEl.style.display=mode==='summary'?'none':'flex';
  summaryMonth.style.display=mode==='summary'?'inline-block':'none';

  btnMonth.classList.toggle('active',mode==='month');
  btnWeek.classList.toggle('active',mode==='week');
  btnSummary.classList.toggle('active',mode==='summary');

  if(mode==='summary') renderSummary();
  else if(mode==='week') renderWeek();
  else renderMonth();
}

function renderMonth(){
  titleEl.textContent=currentDate.toLocaleString('he-IL',{month:'long',year:'numeric'});
  const data=applyFilters();
  const grid=document.createElement('div'); grid.className='grid';
  const y=currentDate.getFullYear(),m=currentDate.getMonth();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  for(let i=0;i<first.getDay();i++) grid.appendChild(document.createElement('div'));
  for(let d=1;d<=last.getDate();d++){
    const cur=new Date(y,m,d);
    grid.appendChild(buildDay(cur,data));
  }
  view.appendChild(grid);
}

function renderWeek(){
  const s=new Date(currentDate); s.setDate(s.getDate()-s.getDay());
  const e=new Date(s); e.setDate(e.getDate()+6);
  titleEl.textContent=`${s.toLocaleDateString('he-IL')} – ${e.toLocaleDateString('he-IL')}`;
  const data=applyFilters();
  const grid=document.createElement('div'); grid.className='grid';
  for(let i=0;i<7;i++){
    const cur=new Date(s); cur.setDate(s.getDate()+i);
    grid.appendChild(buildDay(cur,data));
  }
  view.appendChild(grid);
}

function buildDay(date,data){
  const cell=document.createElement('div'); cell.className='day';
  cell.innerHTML=`<div class='day-header'>${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()} | ${dayNames[date.getDay()]}</div>`;
  data.forEach(r=>r.Dates.forEach((dd,i)=>{
    if(sameDay(dd,date)){
      if(r.EventType==='HOLIDAY'){
        const ev=document.createElement('div'); ev.className='event'; ev.innerHTML=`<strong>חג</strong> ${r.Program}`;
        cell.appendChild(ev);
      }else{
        const ev=document.createElement('div');
        const c=colorFor(r.Employee);
        ev.className='event'+(!r.Employee?' missing':'');
        ev.style.background=c.bg; ev.style.borderRightColor=c.border;
        ev.innerHTML=`<strong>${r.Employee||'חסר מדריך'}</strong><div>${r.Program}</div>`;
        ev.onclick=()=>openSide(r,i,dd);
        cell.appendChild(ev);
      }
    }
  }));
  return cell;
}

function applyFilters(){
  return rawData.filter(r=>(!managerFilter.value||r.Manager===managerFilter.value)&&(!employeeFilter.value||r.Employee===employeeFilter.value));
}

// ======================
// SIDE PANEL
// ======================
function openSide(r,i,date){
  const end=endDate(r);
  sideContent.innerHTML=`<h2>${r.Program}</h2>
    <div class='row'>מפגש: ${i+1}</div>
    <div class='row'>מדריך: ${r.Employee||'חסר מדריך'}</div>
    <div class='row'>תאריך: ${date.toLocaleDateString('he-IL')}</div>
    <div class='row'>בית ספר: ${r.School}</div>
    <div class='row'>רשות: ${r.Authority}</div>
    <div class='row'>תאריך סיום: ${end?end.toLocaleDateString('he-IL'):''}</div>`;
  side.classList.add('open');
}

document.getElementById('closeSide').onclick=()=>side.classList.remove('open');
document.body.onclick=()=>side.classList.remove('open');
side.onclick=e=>e.stopPropagation();

// ======================
// SUMMARY
// ======================
function renderSummary(){
  const [y,m]=summaryMonth.value.split('-').map(Number);
  currentDate=new Date(y,m,1);
  titleEl.textContent=currentDate.toLocaleString('he-IL',{month:'long',year:'numeric'});

  const ended=rawData.map(r=>({r,end:endDate(r)}))
    .filter(x=>x.end&&x.end.getFullYear()===y&&x.end.getMonth()===m)
    .sort((a,b)=>a.end-b.end);

  const wrap=document.createElement('div'); wrap.className='summary-wrap';
  wrap.innerHTML=`<div class='summary-top'><div>קורסים שמסתיימים החודש</div><div style='font-size:36px;font-weight:800'>${ended.length}</div></div>`;

  const managers=[...new Set(rawData.map(r=>r.Manager).filter(Boolean))];
  const split=document.createElement('div'); split.className='summary-split';

  managers.forEach(mgr=>{
    const col=document.createElement('div'); col.className='summary-col';
    const list=ended.filter(x=>x.r.Manager===mgr)
      .map(x=>`<div class='event'><strong>${x.r.Program}</strong><div>${x.r.Authority} · ${x.r.School}</div><div>${x.r.Employee||'—'} · ${x.end.toLocaleDateString('he-IL')}</div></div>`).join('');
    col.innerHTML=`<h3>${mgr}</h3>${list||'<div style="text-align:center;color:#94a3b8">אין קורסים</div>'}`;
    split.appendChild(col);
  });

  wrap.appendChild(split);
  view.appendChild(wrap);
}

// ======================
// EVENTS
// ======================
btnMonth.onclick=()=>{mode='month';render();};
btnWeek.onclick=()=>{mode='week';render();};
btnSummary.onclick=()=>{mode='summary';render();};

btnPrev.onclick=()=>{mode==='week'?currentDate.setDate(currentDate.getDate()-7):currentDate.setMonth(currentDate.getMonth()-1);render();};
btnNext.onclick=()=>{mode==='week'?currentDate.setDate(currentDate.getDate()+7):currentDate.setMonth(currentDate.getMonth()+1);render();};

managerFilter.onchange=render; employeeFilter.onchange=render;
clearFilters.onclick=()=>{managerFilter.value='';employeeFilter.value='';render();};
summaryMonth.onchange=render;

load();
</script>
</body>
</html>
