<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>דשבורד פעילויות</title>
<link rel="icon" href="logo.png" type="image/png" />

<style>
:root{
  --bg:#f8fafc;--card:#ffffff;--border:#e2e8f0;--text:#0f172a;--muted:#64748b;--danger:#dc2626;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}
header{background:#fff;border-bottom:1px solid var(--border)}
.header-inner{max-width:1200px;margin:auto;padding:14px;display:flex;gap:12px;align-items:center}
.app-logo{height:40px}

.controls,.nav{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin:10px}
select,button{height:32px;border:1px solid var(--border);border-radius:8px;background:#fff;padding:0 10px;cursor:pointer}
#btnMonth.active{background:#e0f2fe;border-color:#7dd3fc}
#btnWeek.active{background:#ecfeff;border-color:#67e8f9}
#btnSummary.active{background:#f0fdf4;border-color:#86efac}

.nav{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}

.grid{max-width:1200px;margin:auto;padding:10px;display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
.day{background:var(--card);border-radius:12px;padding:8px;min-height:120px;border:1px solid var(--border)}
.day-header{font-size:11px;font-weight:700;border-bottom:1px solid var(--border);margin-bottom:6px;padding-bottom:4px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.event{padding:6px;border-radius:8px;margin-top:6px;font-size:13px;cursor:pointer;border-right:5px solid #999;background:rgba(255,255,255,.9)}
.event.missing{border:2px solid var(--danger);border-right:5px solid var(--danger);background:#fff}

/* side panel */
.side{position:fixed;top:0;left:0;width:360px;max-width:92%;height:100%;background:#fff;box-shadow:-6px 0 24px rgba(0,0,0,.18);transform:translateX(-100%);transition:.28s ease;z-index:50;padding:18px}
.side.open{transform:translateX(0)}
.side .close{position:absolute;top:12px;left:12px;border:none;background:#f1f5f9;border-radius:8px;width:32px;height:32px;font-size:20px;cursor:pointer}
.side h2{margin:0 0 6px 0;font-size:20px}
.side .subtitle{font-size:13px;color:var(--muted);margin-bottom:14px}
.side .section{border-top:1px solid var(--border);padding-top:12px;margin-top:12px}
.side .row{display:flex;justify-content:space-between;gap:10px;margin:8px 0;font-size:14px}
.side .label{color:var(--muted);font-size:12px}
.side .value{font-weight:600}
.side .badge{display:inline-block;background:#e0f2fe;color:#0369a1;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
.side .danger{color:var(--danger);font-weight:700}

/* summary */
.summary-wrap{max-width:1200px;margin:auto;padding:10px;display:grid;gap:16px}
.summary-top{background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center}
.summary-split{display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:900px;margin:0 auto}
.summary-col{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;max-width:420px;margin:0 auto}

@media(max-width:800px){.grid{grid-template-columns:1fr}.summary-split{grid-template-columns:1fr}}

/* manager header alignment */
.manager-header{display:flex;flex-direction:column;align-items:center;margin-bottom:12px}
.manager-header h3{margin:6px 0;font-size:16px}
.manager-line{height:2px;width:100%;max-width:180px;background:#f59e0b;border-radius:2px}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <img src="logo.png" class="app-logo" />
    <strong>דשבורד פעילויות</strong>
  </div>
</header>

<div class="controls" id="filters">
  <select id="managerFilter"><option value="">כל המנהלים</option></select>
  <select id="employeeFilter"><option value="">כל המדריכים</option></select>
  <button id="clearFilters">נקה סינון</button>
</div>

<div class="nav">
  <select id="summaryMonth" style="display:none"></select>
  <button id="btnMonth" class="active">חודש</button>
  <button id="btnWeek">שבוע</button>
  <button id="btnSummary">סיכום</button>
  <button id="prev">▶</button>
  <span id="title" style="min-width:200px;text-align:center;font-weight:700"></span>
  <button id="next">◀</button>
</div>

<div id="view"></div>

<div class="side" id="side">
  <button class="close" id="closeSide">×</button>
  <div id="sideContent"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ======================
// DATA + STATE
// ======================
const view=document.getElementById('view');
const titleEl=document.getElementById('title');
const filtersEl=document.getElementById('filters');
const side=document.getElementById('side');
const sideContent=document.getElementById('sideContent');

const btnMonth=document.getElementById('btnMonth');
const btnWeek=document.getElementById('btnWeek');
const btnSummary=document.getElementById('btnSummary');
const btnPrev=document.getElementById('prev');
const btnNext=document.getElementById('next');

const managerFilter=document.getElementById('managerFilter');
const employeeFilter=document.getElementById('employeeFilter');
const clearFilters=document.getElementById('clearFilters');
const summaryMonth=document.getElementById('summaryMonth');

let rawData=[];
let mode='month';
let currentDate=new Date(); currentDate.setHours(0,0,0,0);

const dayNames=['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];

// ======================
// HELPERS
// ======================
const sameDay=(a,b)=>a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();

function parseDate(v){
  if(!v) return null;
  if(typeof v==='number'){
    const d=XLSX.SSF.parse_date_code(v);
    return d?new Date(d.y,d.m-1,d.d):null;
  }
  const d=new Date(v); return isNaN(d)?null:d;
}

function endDate(r){
  const d=r.Dates.filter(Boolean);
  return d.length?new Date(Math.max(...d.map(x=>x.getTime()))):null;
}

function colorFor(name){
  if(!name) return {bg:'#fff',border:'#dc2626'};
  let h=0; for(const c of name) h=c.charCodeAt(0)+((h<<5)-h);
  const hue=Math.abs(h)%360;
  return {bg:`hsla(${hue},70%,90%,.8)`,border:`hsl(${hue},70%,45%)`};
}

// ======================
// LOAD EXCEL
// ======================
async function load(){
  const res=await fetch('./DASHBOARD.xlsx',{cache:'no-store'});
  const wb=XLSX.read(await res.arrayBuffer(),{type:'array'});
  const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:''});
  const h=rows[0].map(x=>String(x));
  const col=n=>h.findIndex(x=>x.toLowerCase()===n.toLowerCase());

  rawData=rows.slice(1).map(r=>{
    const g=n=>{const i=col(n); return i>-1?r[i]:''};
    const dates=[]; for(let i=1;i<=16;i++) dates.push(parseDate(g('Date'+i)));
    return{
      Manager: g('Manager'),
      Employee: g('Employee'),
      Program: g('Program'),
      School: g('School'),
      Authority: g('Authority'),
      EventType: g('EventType'),
      End: parseDate(g('End')),
      MonthEnd: parseDate(g('MonthEnd')||g('monthend')||g('MONTHEND')),
      Dates: dates
    };
  }).filter(r=>r.Dates.some(Boolean) || r.MonthEnd);

  initFilters();
  initSummaryMonths();
  render();
}

function initFilters(){
  const managers=[...new Set(rawData.map(r=>r.Manager).filter(Boolean))];
  const employees=[...new Set(rawData.map(r=>r.Employee).filter(Boolean))];
  managerFilter.innerHTML='<option value="">כל המנהלים</option>'+managers.map(v=>`<option>${v}</option>`).join('');
  employeeFilter.innerHTML='<option value="">כל המדריכים</option>'+employees.map(v=>`<option>${v}</option>`).join('');
}

function initSummaryMonths(){
  const months=[...new Set(rawData.map(r=>endDate(r)).filter(Boolean).map(d=>`${d.getFullYear()}-${d.getMonth()}`))].sort();
  summaryMonth.innerHTML=months.map(k=>{
    const [y,m]=k.split('-').map(Number);
    return `<option value="${k}">${new Date(y,m).toLocaleString('he-IL',{month:'long',year:'numeric'})}</option>`;
  }).join('');

  const todayKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
  const idx = months.indexOf(todayKey);
  if(idx >= 0) summaryMonth.selectedIndex = idx;
}

// ======================
// RENDER
// ======================
function render(){
  view.innerHTML='';
  side.classList.remove('open');

  filtersEl.style.display=mode==='summary'?'none':'flex';
  summaryMonth.style.display=mode==='summary'?'inline-block':'none';

  btnMonth.classList.toggle('active',mode==='month');
  btnWeek.classList.toggle('active',mode==='week');
  btnSummary.classList.toggle('active',mode==='summary');

  if(mode==='summary') renderSummary();
  else if(mode==='week') renderWeek();
  else renderMonth();
}

function renderMonth(){
  titleEl.textContent=currentDate.toLocaleString('he-IL',{month:'long',year:'numeric'});
  const data=applyFilters();
  const grid=document.createElement('div'); grid.className='grid';
  const y=currentDate.getFullYear(),m=currentDate.getMonth();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  for(let i=0;i<first.getDay();i++) grid.appendChild(document.createElement('div'));
  for(let d=1;d<=last.getDate();d++){
    const cur=new Date(y,m,d);
    grid.appendChild(buildDay(cur,data));
  }
  view.appendChild(grid);
}

function renderWeek(){
  const s=new Date(currentDate); s.setDate(s.getDate()-s.getDay());
  const e=new Date(s); e.setDate(e.getDate()+6);
  titleEl.textContent=`${s.toLocaleDateString('he-IL')} – ${e.toLocaleDateString('he-IL')}`;
  const data=applyFilters();
  const grid=document.createElement('div'); grid.className='grid';
  for(let i=0;i<7;i++){
    const cur=new Date(s); cur.setDate(s.getDate()+i);
    grid.appendChild(buildDay(cur,data));
  }
  view.appendChild(grid);
}

function buildDay(date,data){
  const cell=document.createElement('div'); cell.className='day';
  cell.innerHTML=`<div class='day-header'>${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()} | ${dayNames[date.getDay()]}</div>`;
  data.forEach(r=>r.Dates.forEach((dd,i)=>{
    if(sameDay(dd,date)){
      if(r.EventType==='HOLIDAY'){
        const ev=document.createElement('div'); ev.className='event'; ev.innerHTML=`<strong>חג</strong> ${r.Program}`;
        cell.appendChild(ev);
      }else{
        const ev=document.createElement('div');
        const c=colorFor(r.Employee);
        ev.className='event'+(!r.Employee?' missing':'');
        ev.style.background=c.bg; ev.style.borderRightColor=c.border;
        ev.innerHTML=`<strong>${r.Employee||'חסר מדריך'}</strong><div>${r.Program}</div>`;
        ev.onclick=(e)=>{ e.stopPropagation(); openSide(r,i,dd); };
        cell.appendChild(ev);
      }
    }
  }));
  return cell;
}

function applyFilters(){
  return rawData.filter(r=>(!managerFilter.value||r.Manager===managerFilter.value)&&(!employeeFilter.value||r.Employee===employeeFilter.value));
}

// ======================
// SIDE PANEL
// ======================
function openSide(r,i,date){
  const end=endDate(r);
  sideContent.innerHTML=`
    <h2>${r.Program}</h2>
    <div class='subtitle'>${r.Manager||''}</div>
    <div class='badge'>מפגש ${i+1}</div>
    <div class='section'>
      <div class='row'><span class='label'>מדריך</span><span class='value'>${r.Employee||'<span class="danger">חסר מדריך</span>'}</span></div>
      <div class='row'><span class='label'>תאריך מפגש</span><span class='value'>${date.toLocaleDateString('he-IL')}</span></div>
      <div class='row'><span class='label'>תאריך סיום קורס</span><span class='value'>${end?end.toLocaleDateString('he-IL'):''}</span></div>
    </div>
    <div class='section'>
      <div class='row'><span class='label'>בית ספר</span><span class='value'>${r.School||'—'}</span></div>
      <div class='row'><span class='label'>רשות</span><span class='value'>${r.Authority||'—'}</span></div>
    </div>`;
  side.classList.add('open');
}

document.getElementById('closeSide').onclick=()=>side.classList.remove('open');
view.onclick=()=>side.classList.remove('open');
side.onclick=e=>e.stopPropagation();

// ======================
// SUMMARY
// ======================
function renderSummary(){
  if(!summaryMonth.value) return;

  const courses = rawData.filter(r=>{
    const type = String(r.EventType||'').trim().toUpperCase();
    return type === 'COURSE' && r.End;
  });

  const [y,m] = summaryMonth.value.split('-').map(Number);
  const monthStart = new Date(y,m,1);
  const totalCoursesInSummary = courses.length;

  const endedBefore = courses.filter(r=>{
    const d = parseDate(r.End);
    return d && d < monthStart;
  }).length;

  const activeTotal = totalCoursesInSummary - endedBefore;

  titleEl.textContent = monthStart.toLocaleString('he-IL',{month:'long',year:'numeric'});

  const wrap = document.createElement('div');
  wrap.className = 'summary-wrap';
  wrap.innerHTML = `
    <div class='summary-top'>
      <div style='font-size:14px;color:#64748b'>סה"כ קורסים פעילים</div>
      <div style='font-size:40px;font-weight:800'>${activeTotal}</div>
    </div>`;

  const managers = [...new Set(courses.map(r=>r.Manager).filter(Boolean))];
  const split = document.createElement('div');
  split.className = 'summary-split';

  managers.forEach(mgr=>{
    const mgrCourses = courses.filter(r=>r.Manager === mgr);
    const mgrEndedBefore = mgrCourses.filter(r=>{
      const d = parseDate(r.End);
      return d && d < monthStart;
    }).length;

    const mgrActive = mgrCourses.length - mgrEndedBefore;
    const mgrEndedThisMonth = mgrCourses.filter(r=>{
        const d = parseDate(r.MonthEnd || r.End);
        return d && d.getFullYear()===y && d.getMonth()===m;
      }).sort((a,b)=>parseDate(a.End)-parseDate(b.End));

    const col = document.createElement('div');
    col.className = 'summary-col';
    col.innerHTML = `
      <div style="text-align:center;margin-bottom:10px">
        <div style="font-size:13px;color:#64748b">קורסים פעילים</div>
        <div style="font-size:26px;font-weight:800">${mgrActive}</div>
      </div>
      <div class="manager-header">
        <h3>${mgr}</h3>
        <div class="manager-line"></div>
      </div>
      <div class="event" style="text-align:center;cursor:pointer;font-weight:400"
           onclick="const el=this.nextElementSibling; el.style.display = el.style.display==='none'?'block':'none'">
        קורסים שמסתיימים החודש: ${mgrEndedThisMonth.length}
      </div>
      <div style="display:none">
        ${mgrEndedThisMonth.length ? mgrEndedThisMonth.map((r,idx)=>{
            const pastelPalette = ['#FDE68A','#BBF7D0','#BFDBFE','#E9D5FF','#FED7AA','#DCFCE7','#E0E7FF','#FBCFE8'];
            const color = pastelPalette[idx % pastelPalette.length];
            return `<div class='event' style="border-right-color:${color};background:${color}">${r.Program}</div>`;
        }).join('') : '<div style="text-align:center;color:#94a3b8">אין קורסים</div>'}
      </div>`;

    split.appendChild(col);
  });

  wrap.appendChild(split);
  view.appendChild(wrap);
}

// ======================
// EVENTS
// ======================
btnMonth.onclick=()=>{mode='month';render();};
btnWeek.onclick=()=>{mode='week';render();};
btnSummary.onclick=()=>{mode='summary';render();};

btnPrev.onclick=()=>{
  if(mode==='summary'){
    summaryMonth.selectedIndex=Math.max(0,summaryMonth.selectedIndex-1);
  }else if(mode==='week'){
    currentDate.setDate(currentDate.getDate()-7);
  }else{
    currentDate.setMonth(currentDate.getMonth()-1);
  }
  render();
};
btnNext.onclick=()=>{
  if(mode==='summary'){
    summaryMonth.selectedIndex=Math.min(summaryMonth.options.length-1,summaryMonth.selectedIndex+1);
  }else if(mode==='week'){
    currentDate.setDate(currentDate.getDate()+7);
  }else{
    currentDate.setMonth(currentDate.getMonth()+1);
  }
  render();
};

managerFilter.onchange=render; employeeFilter.onchange=render;
clearFilters.onclick=()=>{managerFilter.value='';employeeFilter.value='';render();};
summaryMonth.onchange=render;

load();
</script>
</body>
</html>
