<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>דשבורד פעילות ותוכניות</title>

<style>
:root{
  --bg-main:#f8fafc;
  --bg-surface:#eef2f7;
  --card-bg:#ffffff;
  --accent:#2563eb;
  --accent-soft:#e0ecff;
  --text-main:#0f172a;
  --text-muted:#475569;
  --border:#e2e8f0;
}

body{
  margin:0;
  font-family:Assistant,system-ui,sans-serif;
  background:linear-gradient(180deg,var(--bg-main),var(--bg-surface));
  color:var(--text-main);
}

header{
  background:#fff;
  border-bottom:1px solid var(--border);
}

.header-inner{
  max-width:1200px;
  margin:auto;
  padding:14px;
  display:flex;
  gap:16px;
  align-items:center;
}

.app-logo{height:42px;}

.controls,.view-switch,.nav-controls{
  display:flex;
  justify-content:center;
  gap:8px;
  margin:10px auto;
  flex-wrap:wrap;
}

select,button{
  height:30px;
  font-size:12px;
  padding:4px 8px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  box-shadow:0 2px 4px rgba(0,0,0,.08);
}

.view-switch button{width:70px;}
.active-view{background:var(--accent);color:#fff;}
.nav-btn{width:30px;height:30px;border-radius:999px;}

.calendar-grid{
  max-width:1200px;
  margin:auto;
  padding:10px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

.mobile-week-list{
  max-width:1200px;
  margin:auto;
  padding:10px;
  display:none;
}

.mobile-week-card{
  background:var(--card-bg);
  border-radius:14px;
  padding:12px;
  margin-bottom:12px;
  box-shadow:0 6px 16px rgba(0,0,0,.1);
  border:1px solid var(--border);
}

.mobile-week-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
}

.mobile-week-summary{
  font-size:13px;
  color:var(--text-muted);
  margin-top:6px;
  display:flex;
  flex-direction:column;
  gap:4px;
}

.mobile-week-details{
  display:none;
  margin-top:10px;
  border-top:1px solid var(--border);
  padding-top:10px;
}

.mobile-week-card.open .mobile-week-details{
  display:block;
}

.mobile-day{
  margin-bottom:10px;
}

.mobile-day-title{
  font-weight:700;
  margin-bottom:6px;
}

.mobile-session{
  background:linear-gradient(135deg,var(--accent-soft),#fff);
  border-radius:10px;
  padding:8px;
  margin-bottom:6px;
  font-size:12px;
}

.mobile-toggle{
  border:none;
  background:var(--accent);
  color:#fff;
  border-radius:8px;
  padding:4px 8px;
  font-size:12px;
  cursor:pointer;
}

.day{
  background:var(--card-bg);
  border-radius:14px;
  padding:12px;
  min-width:220px;
  box-shadow:0 6px 16px rgba(0,0,0,.1);
}

.event{
  background:linear-gradient(135deg,var(--accent-soft),#fff);
  border-radius:10px;
  padding:6px;
  margin-top:6px;
  font-size:13px;
}

.meta{
  font-size:12px;
  color:var(--text-muted);
}

@media (max-width:768px){
  .desktop-view{
    display:none;
  }

  .view-switch{
    display:none;
  }

  .nav-controls{
    display:none;
  }

  .calendar-grid{
    padding:0;
  }

  .mobile-week-card{
    padding:12px;
    margin-bottom:10px;
    border-radius:10px;
  }

  .mobile-week-details{
    display:none;
  }

  .mobile-week-card.open .mobile-week-details{
    display:block;
  }

  .mobile-week-list{
    display:block;
    padding:10px;
  }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <img src="logo.png" class="app-logo">
    <div>
      <strong>דשבורד פעילות ותוכניות</strong><br>
      <span class="meta">ניהול ומעקב תהליכי</span>
    </div>
  </div>
</header>

<div class="controls">
  <select id="managerFilter"><option value="">בחר מנהל</option></select>
  <select id="workerFilter"><option value="">בחר עובד</option></select>
  <select id="programFilter"><option value="">בחר תוכנית</option></select>
  <button id="clearFilters">נקה סינון</button>
</div>

<div class="view-switch">
  <button id="viewWeek" class="active-view">שבוע</button>
  <button id="viewMonth">חודש</button>
  <button id="viewWorker">עובד</button>
</div>

<div class="nav-controls">
  <button id="prevNav" class="nav-btn">◀</button>
  <span id="navTitle"></span>
  <button id="nextNav" class="nav-btn">▶</button>
</div>

<div id="calendarGrid" class="calendar-grid desktop-view"></div>
<div id="mobileWeekList" class="mobile-week-list"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ================= CONFIG =================
const EXCEL_URL = 'DASHBOARD.xlsx';

// ================= STATE =================
let rawData = [];
let currentView = 'week';
let currentDate = new Date();
currentDate.setHours(0,0,0,0);
let isMobile = window.innerWidth <= 768;

const days = ['ראשון','שני','שלישי','רביעי','חמישי','שישי'];

// ================= NORMALIZATION =================
function normalizeText(value){
  if(typeof value !== 'string') return value;
  return value
    .replace(/\u00A0/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}

function normalizeHeader(value){
  if(typeof value !== 'string') return '';
  return value.toLowerCase().replace(/\s+/g,'');
}

// ================= DATE PARSER =================
function parseDate(val){
  if(typeof val === 'number'){
    const base = new Date(1899,11,30);
    const d = new Date(base.getTime()+val*86400000);
    d.setHours(0,0,0,0);
    return d;
  }
  if(typeof val === 'string' && val.trim()){
    const v = val.trim();
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v)){
      const [d,m,y] = v.split('/').map(Number);
      const dt = new Date(y,m-1,d);
      dt.setHours(0,0,0,0);
      return dt;
    }
    const dt = new Date(v);
    if(!isNaN(dt)){
      dt.setHours(0,0,0,0);
      return dt;
    }
  }
  return null;
}

function sameDay(a,b){return a && b && a.getTime()===b.getTime();}

function parseDateSafe(value, rowIndex, header){
  if(!value) return null;
  if(value instanceof Date){
    const dt = new Date(value);
    dt.setHours(0,0,0,0);
    return dt;
  }
  const parsed = parseDate(value);
  if(parsed) return parsed;

  if(typeof value === 'string'){
    const v = value.trim();
    const match = v.match(/^(\d{2})\.(\d{2})\.(\d{2})$/);
    if(match){
      const [,d,m,y] = match;
      const dt = new Date(`20${y}-${m}-${d}`);
      if(!isNaN(dt)){
        dt.setHours(0,0,0,0);
        return dt;
      }
    }
  }

  console.warn('Unparsed date value:', value, 'in row', rowIndex, 'header', header);
  return null;
}

// ================= LOAD EXCEL =================
async function loadExcel(){
  const res = await fetch(EXCEL_URL,{cache:'no-store'});
  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf,{type:'array'});
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
  rawData = buildRecords(rows);
  initFilters();
  render();
}

function buildRecords(rows){
  if(!rows.length) return [];
  const headers = rows[0] || [];
  const mappedHeaders = headers.map((header)=>{
    const normalized = normalizeHeader(String(header || ''));
    if(!normalized) return null;
    if(normalized === 'employee') return 'Employee';
    if(normalized === 'program') return 'Program';
    if(normalized === 'municipality') return 'Municipality';
    if(normalized === 'authority') return 'Authority';
    if(normalized === 'manager') return 'Manager';
    if(normalized === 'school') return 'School';
    if(normalized === 'day') return 'Day';
    if(normalized === 'starttime') return 'StartTime';
    if(normalized === 'endtime') return 'EndTime';
    if(/^date\d+$/.test(normalized)){
      const index = Number(normalized.replace('date',''));
      if(index >= 1 && index <= 16){
        return `Date${index}`;
      }
      console.warn('Unrecognized Date column:', header);
      return null;
    }
    return header || null;
  });

  return rows.slice(1).map((row,rowIndex)=>{
    const record = {__rowIndex: rowIndex + 2};
    mappedHeaders.forEach((key,cellIndex)=>{
      if(!key) return;
      record[key] = row[cellIndex] ?? '';
    });

    ['Employee','Manager','Program','Authority','School'].forEach((field)=>{
      if(field in record){
        record[field] = normalizeText(record[field]);
      }
    });

    return record;
  });
}

// ================= FILTERS =================
function initFilters(){
  fillFilter('managerFilter','Manager');
  fillFilter('workerFilter','Employee');
  fillFilter('programFilter','Program');
}

function fillFilter(id,key){
  const sel = document.getElementById(id);
  const values = [...new Set(rawData.map(r=>r[key]).filter(Boolean))];
  sel.innerHTML = `<option value="">בחר ${key}</option>` + values.map(v=>`<option>${v}</option>`).join('');
  sel.onchange = render;
}

function filteredData(){
  return rawData.filter(r=>{
    const selectedManager = normalizeText(managerFilter.value);
    const selectedWorker = normalizeText(workerFilter.value);
    const selectedProgram = normalizeText(programFilter.value);
    const manager = normalizeText(r.Manager);
    const worker = normalizeText(r.Employee);
    const program = normalizeText(r.Program);

    if(selectedManager && !manager){
      console.warn('Record filtered due to empty Manager value:', r, 'row', r.__rowIndex);
      return false;
    }
    if(selectedWorker && !worker){
      console.warn('Record filtered due to empty Employee value:', r, 'row', r.__rowIndex);
      return false;
    }
    if(selectedProgram && !program){
      console.warn('Record filtered due to empty Program value:', r, 'row', r.__rowIndex);
      return false;
    }

    return (!selectedManager || manager===selectedManager)
      && (!selectedWorker || worker===selectedWorker)
      && (!selectedProgram || program===selectedProgram);
  });
}

// ================= RENDER =================
function render(){
  calendarGrid.innerHTML = '';
  mobileWeekList.innerHTML = '';
  const data = filteredData();

  if(isMobile){
    currentView = 'week';
    renderMobileWeeks(data);
    return;
  }

  // -------- WEEK VIEW --------
  if(currentView==='week'){
    const start = startOfWeek(currentDate);
    navTitle.textContent = 'שבוע החל מ־' + start.toLocaleDateString('he-IL');

    for(let i=0;i<6;i++){
      const dayDate = new Date(start);
      dayDate.setDate(start.getDate()+i);

      let html='';
      data.forEach(r=>{
        for(let j=1;j<=16;j++){
          const d = parseDateSafe(r['Date'+j], r.__rowIndex, `Date${j}`);
          if(d && sameDay(d,dayDate)){
            html += `<div class="event">
              <strong>${r.Employee}</strong>
              <div class="meta">${r.School} · ${r.Municipality}</div>
              <div class="meta">${r.Program} · מפגש ${j}</div>
            </div>`;
          }
        }
      });

      calendarGrid.innerHTML += `<div class="day"><strong>${days[i]}</strong>${html || '<div class="meta">—</div>'}</div>`;
    }
  }

  // -------- MONTH VIEW --------
  if(currentView==='month'){
    navTitle.textContent = 'חודש ' + (currentDate.getMonth()+1) + '/' + currentDate.getFullYear();

    data.forEach(r=>{
      for(let j=1;j<=16;j++){
        const d = parseDateSafe(r['Date'+j], r.__rowIndex, `Date${j}`);
        if(d && d.getMonth()===currentDate.getMonth() && d.getFullYear()===currentDate.getFullYear()){
          calendarGrid.innerHTML += `<div class="day">
            <strong>${d.toLocaleDateString('he-IL')}</strong>
            <div class="event">
              <strong>${r.Employee}</strong>
              <div class="meta">${r.School} · ${r.Municipality}</div>
              <div class="meta">${r.Program} · מפגש ${j}</div>
            </div>
          </div>`;
        }
      }
    });
  }

  // -------- WORKER VIEW --------
  if(currentView==='worker'){
    navTitle.textContent = 'תצוגת עובד';
    const byWorker = {};

    data.forEach(r=>{
      if(!byWorker[r.Employee]){
        byWorker[r.Employee] = {info:r, dates:[]};
      }
      for(let j=1;j<=16;j++){
        const d = parseDateSafe(r['Date'+j], r.__rowIndex, `Date${j}`);
        if(d) byWorker[r.Employee].dates.push(d);
      }
    });

    Object.keys(byWorker).forEach(name=>{
      const entry = byWorker[name];
      const dates = entry.dates.sort((a,b)=>a-b);
      const info = entry.info;

      calendarGrid.innerHTML += `<div class="day">
        <strong>${name}</strong>
        <div class="meta">${info.School} · ${info.Municipality}</div>
        <div class="event">${info.Program}</div>
        <div class="meta">מפגשים: ${dates.length}</div>
        <div class="meta">ראשון: ${dates[0]?.toLocaleDateString('he-IL') || '-'}</div>
        <div class="meta">אחרון: ${dates[dates.length-1]?.toLocaleDateString('he-IL') || '-'}</div>
      </div>`;
    });
  }
}

function buildWeeklySessions(data){
  const weeks = new Map();

  data.forEach(r=>{
    const startTime = r.StartTime;
    const endTime = r.EndTime;
    const durationHours = getDurationHours(startTime,endTime);
    for(let j=1;j<=16;j++){
      const d = parseDateSafe(r['Date'+j], r.__rowIndex, `Date${j}`);
      if(!d) continue;
      const weekStart = startOfWeek(d);
      const weekKey = weekStart.toISOString();
      if(!weeks.has(weekKey)){
        weeks.set(weekKey,{start:weekStart, sessions:[]});
      }
      weeks.get(weekKey).sessions.push({
        date:d,
        program:r.Program,
        school:r.School,
        authority:r.Authority || r.Municipality,
        startTime,
        endTime,
        durationHours
      });
    }
  });

  return Array.from(weeks.values()).sort((a,b)=>a.start-b.start);
}

function renderMobileWeeks(data){
  navTitle.textContent = 'תצוגת שבוע';
  const weeks = buildWeeklySessions(data);

  if(!weeks.length){
    mobileWeekList.innerHTML = '<div class="meta">—</div>';
    return;
  }

  weeks.forEach((week, index)=>{
    const weekStart = week.start;
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate()+6);

    const sessionsByDay = {};
    let totalHours = 0;
    week.sessions.forEach((session)=>{
      const key = session.date.toISOString().slice(0,10);
      if(!sessionsByDay[key]){
        sessionsByDay[key] = {date:session.date, sessions:[]};
      }
      sessionsByDay[key].sessions.push(session);
      totalHours += session.durationHours;
    });

    const daysWithMultiple = Object.values(sessionsByDay).some(day=>day.sessions.length > 1);
    const totalMeetings = week.sessions.length;

    const detailsHtml = Object.values(sessionsByDay)
      .sort((a,b)=>a.date-b.date)
      .map((day)=>{
        const dayTotal = day.sessions.reduce((sum,s)=>sum+s.durationHours,0);
        const sessionsHtml = day.sessions.map((session)=>{
          const timeRange = [formatTime(session.startTime), formatTime(session.endTime)].filter(Boolean).join('–');
          return `<div class="mobile-session">
            <div><strong>${session.program || '-'}</strong></div>
            <div class="meta">${session.school || '-'} · ${session.authority || '-'}</div>
            <div class="meta">${timeRange || '-'}</div>
          </div>`;
        }).join('');
        return `<div class="mobile-day">
          <div class="mobile-day-title">${day.date.toLocaleDateString('he-IL')}</div>
          ${sessionsHtml}
          <div class="meta">סה״כ שעות ליום: ${dayTotal.toFixed(1)}</div>
        </div>`;
      }).join('');

    mobileWeekList.innerHTML += `<div class="mobile-week-card" data-week="${index}">
      <div class="mobile-week-header">
        <strong>${formatDateRange(weekStart,weekEnd)}</strong>
        <button class="mobile-toggle" type="button">פרטים</button>
      </div>
      <div class="mobile-week-summary">
        <span>מספר מפגשים: ${totalMeetings}</span>
        <span>סה״כ שעות שבועיות: ${totalHours.toFixed(1)}</span>
        <span>${daysWithMultiple ? 'יש יותר ממפגש אחד ביום' : 'מפגש אחד ביום לכל היותר'}</span>
      </div>
      <div class="mobile-week-details">
        ${detailsHtml}
      </div>
    </div>`;
  });

  document.querySelectorAll('.mobile-week-card').forEach(card=>{
    card.onclick = (event)=>{
      if(event.target.classList.contains('mobile-toggle') || event.target.closest('.mobile-week-header')){
        card.classList.toggle('open');
      }
    };
  });
}

// ================= EVENTS =================
viewWeek.onclick = ()=>{currentView='week';render();};
viewMonth.onclick = ()=>{currentView='month';render();};
viewWorker.onclick = ()=>{currentView='worker';render();};
prevNav.onclick = ()=>{currentDate.setDate(currentDate.getDate()-7);render();};
nextNav.onclick = ()=>{currentDate.setDate(currentDate.getDate()+7);render();};
clearFilters.onclick = ()=>{managerFilter.value=workerFilter.value=programFilter.value='';render();};
window.onresize = ()=>{
  const nextIsMobile = window.innerWidth <= 768;
  if(nextIsMobile !== isMobile){
    isMobile = nextIsMobile;
    render();
  }
};

loadExcel();
</script>
</body>
</html>
