<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>דשבורד פעילויות</title>

<style>
:root{
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e2e8f0;
  --text:#0f172a;
  --muted:#64748b;
  --danger:#dc2626;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--text)}

header{background:#fff;border-bottom:1px solid var(--border)}
.header-inner{max-width:1200px;margin:auto;padding:14px;font-weight:700}

.controls,.nav{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:10px}
select,button{
  height:32px;border:1px solid var(--border);border-radius:8px;
  background:#fff;padding:0 10px;cursor:pointer
}
button.active{background:#e0ecff;border-color:#93c5fd}

.grid{
  max-width:1200px;margin:auto;padding:10px;
  display:grid;grid-template-columns:repeat(7,1fr);gap:12px
}
.day{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px;min-height:120px}
.day-header{font-size:12px;font-weight:700;border-bottom:1px solid var(--border);margin-bottom:6px;text-align:center}

.event{
  border-right:5px solid;
  padding:6px;border-radius:8px;margin-top:6px;
  font-size:13px;cursor:pointer;background:#fff
}
.event.missing{border:2px solid var(--danger);border-right-color:var(--danger)}

.side{
  position:fixed;top:0;left:0;height:100%;width:320px;
  background:#fff;box-shadow:-4px 0 20px rgba(0,0,0,.2);
  transform:translateX(-100%);transition:.25s;padding:16px;z-index:100
}
.side.open{transform:translateX(0)}
.side h3{margin-top:0}
.side .row{margin:6px 0;font-size:14px}

.summary-wrap{max-width:1200px;margin:auto;padding:10px;display:grid;gap:16px}
.summary-top{background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center}
.summary-split{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.summary-col{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px}

@media(max-width:800px){
  .grid{grid-template-columns:1fr}
  .summary-split{grid-template-columns:1fr}
}
</style>
</head>

<body>
<header>
  <div class="header-inner">דשבורד פעילויות</div>
</header>

<div class="controls" id="filters">
  <select id="managerFilter"><option value="">כל המנהלים</option></select>
  <select id="employeeFilter"><option value="">כל המדריכים</option></select>
  <button id="clearFilters">נקה סינון</button>
</div>

<div class="nav">
  <select id="summaryMonth" style="display:none"></select>
  <button id="btnMonth" class="active">חודש</button>
  <button id="btnWeek">שבוע</button>
  <button id="btnSummary">סיכום</button>
  <button id="prev">◀</button>
  <span id="title" style="min-width:200px;text-align:center;font-weight:700"></span>
  <button id="next">▶</button>
</div>

<div id="view"></div>

<div class="side" id="side">
  <button onclick="closeSide()">✕</button>
  <div id="sideContent"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const view=document.getElementById('view');
const titleEl=document.getElementById('title');
const side=document.getElementById('side');
const sideContent=document.getElementById('sideContent');

let raw=[],mode='month';
let current=new Date();current.setHours(0,0,0,0);

const dayNames=['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];

const sameDay=(a,b)=>a&&b&&a.toDateString()===b.toDateString();

function colorFor(name){
  if(!name) return {bg:'#fff',border:'#dc2626'};
  let h=0;for(const c of name)h=c.charCodeAt(0)+((h<<5)-h);
  const hue=Math.abs(h)%360;
  return{
    bg:`hsla(${hue},70%,90%,.8)`,
    border:`hsl(${hue},70%,45%)`
  };
}

function parseDate(v){
  if(!v)return null;
  if(typeof v==='number'){
    const d=XLSX.SSF.parse_date_code(v);
    return new Date(d.y,d.m-1,d.d);
  }
  const d=new Date(v);return isNaN(d)?null:d;
}

function getEnd(r){
  const d=r.Dates.filter(Boolean);
  return new Date(Math.max(...d.map(x=>x.getTime())));
}

function openSide(r,idx){
  const end=getEnd(r);
  sideContent.innerHTML=`
    <h3>${r.Program}</h3>
    <div class="row">מדריך: ${r.Employee||'—'}</div>
    <div class="row">מפגש: ${idx+1}</div>
    <div class="row">בית ספר: ${r.School}</div>
    <div class="row">רשות: ${r.Authority}</div>
    <div class="row">תאריך סיום: ${end.toLocaleDateString('he-IL')}</div>
  `;
  side.classList.add('open');
}
function closeSide(){side.classList.remove('open');}

function render(){
  view.innerHTML='';
  if(mode==='summary') renderSummary();
  else if(mode==='week') renderWeek();
  else renderMonth();
}

function renderMonth(){
  titleEl.textContent=current.toLocaleString('he-IL',{month:'long',year:'numeric'});
  const grid=document.createElement('div');grid.className='grid';
  const y=current.getFullYear(),m=current.getMonth();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  for(let i=0;i<first.getDay();i++)grid.appendChild(document.createElement('div'));
  for(let d=1;d<=last.getDate();d++){
    const cur=new Date(y,m,d);
    const cell=document.createElement('div');cell.className='day';
    cell.innerHTML=`<div class="day-header">${d}/${m+1}/${y} | ${dayNames[cur.getDay()]}</div>`;
    raw.forEach(r=>r.Dates.forEach((dd,i)=>{
      if(sameDay(dd,cur)){
        const ev=document.createElement('div');
        const c=colorFor(r.Employee);
        ev.className='event'+(!r.Employee?' missing':'');
        ev.style.background=c.bg;
        ev.style.borderRightColor=c.border;
        ev.innerHTML=`<strong>${r.Employee||'חסר מדריך'}</strong><small>${r.Program}</small>`;
        ev.onclick=()=>openSide(r,i);
        cell.appendChild(ev);
      }
    }));
    grid.appendChild(cell);
  }
  view.appendChild(grid);
}

function renderWeek(){
  const s=new Date(current);s.setDate(s.getDate()-s.getDay());
  titleEl.textContent='שבוע';
  const grid=document.createElement('div');grid.className='grid';
  for(let i=0;i<7;i++){
    const cur=new Date(s);cur.setDate(s.getDate()+i);
    const cell=document.createElement('div');cell.className='day';
    cell.innerHTML=`<div class="day-header">${cur.getDate()}/${cur.getMonth()+1} | ${dayNames[i]}</div>`;
    raw.forEach(r=>r.Dates.forEach((dd,j)=>{
      if(sameDay(dd,cur)){
        const ev=document.createElement('div');
        const c=colorFor(r.Employee);
        ev.className='event'+(!r.Employee?' missing':'');
        ev.style.background=c.bg;
        ev.style.borderRightColor=c.border;
        ev.innerHTML=`<strong>${r.Employee||'חסר מדריך'}</strong><small>${r.Program}</small>`;
        ev.onclick=()=>openSide(r,j);
        cell.appendChild(ev);
      }
    }));
    grid.appendChild(cell);
  }
  view.appendChild(grid);
}

function renderSummary(){
  const m=current.getMonth(),y=current.getFullYear();
  titleEl.textContent=current.toLocaleString('he-IL',{month:'long',year:'numeric'});
  const wrap=document.createElement('div');wrap.className='summary-wrap';

  const ended=raw.map(r=>({r,end:getEnd(r)}))
    .filter(x=>x.end.getMonth()===m&&x.end.getFullYear()===y)
    .sort((a,b)=>a.end-b.end);

  wrap.innerHTML=`
    <div class="summary-top">
      <div>קורסים שמסתיימים החודש</div>
      <div style="font-size:36px;font-weight:800">${ended.length}</div>
    </div>
  `;

  const managers=[...new Set(raw.map(r=>r.Manager).filter(Boolean))].slice(0,2);
  const split=document.createElement('div');split.className='summary-split';

  managers.forEach(mgr=>{
    const col=document.createElement('div');col.className='summary-col';
    col.innerHTML=`<h3>${mgr}</h3>`;
    const list=ended.filter(x=>x.r.Manager===mgr);
    if(!list.length){
      col.innerHTML+='<div style="color:#94a3b8;text-align:center">אין קורסים</div>';
    }else{
      list.forEach(x=>{
        const c=colorFor(x.r.Employee);
        const ev=document.createElement('div');
        ev.className='event';
        ev.style.background=c.bg;
        ev.style.borderRightColor=c.border;
        ev.innerHTML=`<strong>${x.r.Employee}</strong><small>${x.r.Program}</small>`;
        ev.onclick=()=>openSide(x.r,x.r.Dates.length-1);
        col.appendChild(ev);
      });
    }
    split.appendChild(col);
  });

  wrap.appendChild(split);
  view.appendChild(wrap);
}

async function load(){
  const res=await fetch('./DASHBOARD.xlsx',{cache:'no-store'});
  const wb=XLSX.read(await res.arrayBuffer(),{type:'array'});
  const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:''});
  raw=rows.slice(1).map(r=>{
    const g=n=>r[rows[0].indexOf(n)]||'';
    return{
      Manager:g('Manager'),
      Employee:g('Employee'),
      Program:g('Program'),
      School:g('School'),
      Authority:g('Authority'),
      Dates:[...Array(16)].map((_,i)=>parseDate(g('date'+(i+1))))
    };
  }).filter(r=>r.Dates.some(Boolean));
  render();
}

document.getElementById('btnMonth').onclick=()=>{mode='month';render()};
document.getElementById('btnWeek').onclick=()=>{mode='week';render()};
document.getElementById('btnSummary').onclick=()=>{mode='summary';render()};
document.getElementById('prev').onclick=()=>{current.setMonth(current.getMonth()-1);render()};
document.getElementById('next').onclick=()=>{current.setMonth(current.getMonth()+1);render()};

load();
</script>
</body>
</html>
